<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Veresia – Настройки / Обучение</title>
<style>
  :root{--bg:#0e1116;--ink:#f8fafc}
  html,body{margin:0;height:100%;background:#0b0f14;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .topbar{position:fixed;inset:0 0 auto 0;display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:rgba(11,15,20,.65);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:5}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.18);color:#e5e7eb;background:transparent;padding:.45rem .7rem;border-radius:.5rem;font-size:.95rem;cursor:pointer}
  .btn.primary{border-color:#60a5fa;background:#1e293b}
  .wrap{padding:60px .75rem 1rem;display:grid;grid-template-columns:1fr 380px;gap:1rem}
  .pad{border:1px solid #22304f;border-radius:.75rem;background:#0b1220;overflow:hidden}
  canvas{width:100%;height:70vh;display:block;background:#0e1116}
  .side{border:1px solid #22304f;border-radius:.75rem;background:#0b1220;padding:.8rem}
  .field{margin:.6rem 0;display:grid;gap:.35rem}
  input,select{background:#0d1628;border:1px solid #24314f;color:#e5e7eb;border-radius:.5rem;padding:.45rem .6rem}
  label{font-size:.9rem;opacity:.9}
  .row{display:flex;gap:.5rem;flex-wrap:wrap}
  .kbd{display:grid;grid-template-columns:repeat(11,1fr);gap:.35rem}
  .key{border:1px solid #2b3b64;background:#0c1426;color:#e5e7eb;border-radius:.4rem;padding:.35rem .2rem;text-align:center;cursor:pointer}
  .key.active{background:#1e293b;border-color:#60a5fa}
  .small{opacity:.85;font-size:.9rem}
  .pill{display:inline-block;font-size:.8rem;padding:.15rem .45rem;border:1px solid #2b3b64;border-radius:999px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111827;border:1px solid #374151;padding:.6rem .8rem;border-radius:.6rem;z-index:10;display:none}
  .toast.show{display:block}
</style>
</head>
<body>
  <div class="topbar">
    <strong>Настройки / Обучение</strong>
    <div style="flex:1"></div>
    <a class="btn" href="./index.html">⬅ Назад</a>
  </div>

  <div class="wrap">
    <div class="pad"><canvas id="pad"></canvas></div>

    <aside class="side">
      <div class="field">
        <label>Профил</label>
        <select id="profile">
          <option value="asen">Асен</option>
          <option value="dimcho" selected>Димчо</option>
          <option value="maria">Мария</option>
        </select>
      </div>

      <div class="field">
        <label>Режим</label>
        <select id="mode">
          <option value="letters" selected>Букви (азбука)</option>
          <option value="names">Имена (по избор)</option>
        </select>
        <small id="modeHint" class="small">Избери буква от клавиатурата по-долу и записвай примери.</small>
      </div>

      <div id="namesBox" class="field" style="display:none">
        <label>Име (кирилица)</label>
        <input id="nameLabel" placeholder="напр. Иван" autocapitalize="off" autocorrect="off" spellcheck="false"/>
      </div>

      <div id="lettersBox" class="field">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div>Текуща буква: <strong id="curLetter">—</strong> <span id="cnt" class="pill">0 примера</span></div>
          <div class="row">
            <button id="btnUpper" class="btn">Главни</button>
            <button id="btnLower" class="btn primary">Малки</button>
          </div>
        </div>
        <div id="kbd" class="kbd"></div>
      </div>

      <div class="row" style="margin-top:.4rem">
        <button id="btnClear" class="btn">Изчисти платното</button>
        <button id="btnSaveStroke" class="btn primary">Запази пример</button>
      </div>

      <hr style="border-color:#22304f;margin:.8rem 0"/>

      <div class="row">
        <button id="btnExport" class="btn">Експорт модел</button>
        <button id="btnImport" class="btn">Импорт модел</button>
      </div>
      <small class="small">Моделът се пази локално (IndexedDB). Експорт/Импорт – JSON файл.</small>
    </aside>
  </div>

  <div id="toast" class="toast"></div>

<script>
/*** ЛОКАЛЕН „МОДЕЛ“ ***/
const DB='veresia-train', STORE='models', VER=1;
function withDB(mode,fn){return new Promise((res,rej)=>{const r=indexedDB.open(DB,VER);
r.onupgradeneeded=()=>{const db=r.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);};
r.onerror=()=>rej(r.error);
r.onsuccess=()=>{const tx=r.result.transaction(STORE,mode);const s=tx.objectStore(STORE);
Promise.resolve(fn(s)).then(v=>{tx.oncomplete=()=>res(v);tx.onerror=()=>rej(tx.error);},rej);} }) }
const idb={get:k=>withDB('readonly',s=>new Promise((res,rej)=>{const r=s.get(k);r.onsuccess=()=>res(r.result||{samples:[]});r.onerror=()=>rej(r.error)})),
           set:(k,v)=>withDB('readwrite',s=>new Promise((res,rej)=>{const r=s.put(v,k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)}))};

/*** КАНВАС ***/
const pad=document.getElementById('pad');
const ctx=pad.getContext('2d',{willReadFrequently:true});
let drawing=false,last=null;
function resize(){const dpr=window.devicePixelRatio||1;const r=pad.getBoundingClientRect();
  pad.width=Math.floor(r.width*dpr);pad.height=Math.floor(r.height*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);ctx.strokeStyle='#f8fafc';ctx.lineJoin='round';ctx.lineCap='round';}
window.addEventListener('resize',resize);resize();
const isPen=e=>e.pointerType==='pen'||(e.pointerType==='mouse'&&e.buttons===1);
const pos=e=>{const r=pad.getBoundingClientRect();return {x:e.clientX-r.left,y:e.clientY-r.top,p:e.pressure||0.5}};
pad.addEventListener('pointerdown',e=>{if(!isPen(e))return;e.preventDefault();drawing=true;last=pos(e)});
pad.addEventListener('pointermove',e=>{if(!drawing||!isPen(e))return;const p=pos(e);ctx.lineWidth=2+p.p*4;ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;});
['pointerup','pointercancel','pointerleave'].forEach(ev=>pad.addEventListener(ev,()=>{drawing=false;last=null}));

/*** UI ***/
const tEl=document.getElementById('toast');
function toast(m,ms=1800){tEl.textContent=m;tEl.classList.add('show');clearTimeout(tEl._t);tEl._t=setTimeout(()=>tEl.classList.remove('show'),ms)}

const profile=document.getElementById('profile');
const mode=document.getElementById('mode');
const modeHint=document.getElementById('modeHint');
const lettersBox=document.getElementById('lettersBox');
const namesBox=document.getElementById('namesBox');
const nameLabel=document.getElementById('nameLabel');

const kbdWrap=document.getElementById('kbd');
const curLetterEl=document.getElementById('curLetter');
const cntEl=document.getElementById('cnt');
const btnUpper=document.getElementById('btnUpper');
const btnLower=document.getElementById('btnLower');

let currentLetter='';
let isLower=true;

const CYR_LOW = 'абвгдежзийклмнопрстуфхцчшщъьюя';
const CYR_UP  = 'АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЬЮЯ';
const EXTRA = ['ѝ','Ѝ'];

function renderKeyboard(){
  kbdWrap.innerHTML='';
  const letters = isLower ? (CYR_LOW + EXTRA.map(x=>x.toLowerCase()).join(''))
                          : (CYR_UP + EXTRA.map(x=>x.toUpperCase()).join(''));
  [...letters].forEach(ch=>{
    const b=document.createElement('button'); b.type='button'; b.className='key'; b.textContent=ch;
    if(ch===currentLetter) b.classList.add('active');
    b.onclick=()=>{ currentLetter=ch; updateCurrentCount(); [...kbdWrap.children].forEach(x=>x.classList.remove('active')); b.classList.add('active'); curLetterEl.textContent=currentLetter; };
    kbdWrap.appendChild(b);
  });
  curLetterEl.textContent = currentLetter || '—';
}
btnUpper.onclick=()=>{isLower=false;btnUpper.classList.add('primary');btnLower.classList.remove('primary');renderKeyboard()};
btnLower.onclick=()=>{isLower=true;btnLower.classList.add('primary');btnUpper.classList.remove('primary');renderKeyboard()};

function onlyCyr(s){return (s||'').replace(/[^\p{Script=Cyrillic}\s.'’-]/gu,'').replace(/\s+/g,' ').trim()}

async function updateCurrentCount(){
  const key=`${profile.value}:${mode.value}`;
  const model=await idb.get(key);
  const target = mode.value==='letters' ? currentLetter : onlyCyr(nameLabel.value);
  const count = model.samples.filter(x=>x.label===target).length;
  cntEl.textContent = `${count} примера`;
}

function syncModeUI(){
  const m=mode.value;
  if(m==='letters'){
    lettersBox.style.display='';
    namesBox.style.display='none';
    modeHint.textContent='Избери буква от клавиатурата по-долу и записвай примери.';
  }else{
    lettersBox.style.display='none';
    namesBox.style.display='';
    modeHint.textContent='Въведи пълно име (кирилица), след това запазвай примери.';
  }
  updateCurrentCount();
}

profile.onchange=updateCurrentCount;
mode.onchange=syncModeUI;
nameLabel.oninput=updateCurrentCount;

document.getElementById('btnClear').onclick=()=>ctx.clearRect(0,0,pad.width,pad.height);

document.getElementById('btnSaveStroke').onclick=async()=>{
  const key=`${profile.value}:${mode.value}`;
  const model=await idb.get(key);
  const data=pad.toDataURL('image/png');

  let labelValue='';
  if(mode.value==='letters'){
    if(!currentLetter){toast('Избери буква от клавиатурата.');return;}
    labelValue=currentLetter;
  }else{
    const nm=onlyCyr(nameLabel.value);
    if(!nm){toast('Въведи име на кирилица.');return;}
    labelValue=nm;
  }

  model.samples.push({label:labelValue,data,ts:Date.now()});
  await idb.set(key,model);
  toast('Добавен пример');
  ctx.clearRect(0,0,pad.width,pad.height);
  updateCurrentCount();
};

document.getElementById('btnExport').onclick=async()=>{
  const keys=[`asen:letters`,`dimcho:letters`,`maria:letters`,`asen:names`,`dimcho:names`,`maria:names`];
  const dump={}; for(const k of keys){dump[k]=await idb.get(k)}
  const blob=new Blob([JSON.stringify(dump)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='veresia-model.json';
  document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove()},0);
};

document.getElementById('btnImport').onclick=async()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=async()=>{
    const f=inp.files[0]; if(!f) return;
    try{
      const txt=await f.text(); const dump=JSON.parse(txt);
      for(const [k,v] of Object.entries(dump||{})){ await idb.set(k, v||{samples:[]}); }
      toast('Импорт завършен'); updateCurrentCount();
    }catch(e){ toast('Невалиден файл'); }
  };
  inp.click();
};

// init
renderKeyboard(); syncModeUI(); updateCurrentCount();
</script>
</body>
</html>
