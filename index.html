<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Veresia</title>
<style>
  :root{--bg:#0e1116;--line:#1e3558;--ink:#f8fafc}
  html,body{margin:0;height:100%;background:#0b0f14;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;touch-action:none}
  .topbar{position:fixed;inset:0 0 auto 0;display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:rgba(11,15,20,.65);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:5}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.18);color:#e5e7eb;background:transparent;padding:.45rem .7rem;border-radius:.5rem;font-size:.95rem;cursor:pointer}
  .btn:hover{border-color:#ffffff44}
  .btn.primary{border-color:#60a5fa;background:#1e293b}
  .sep{flex:1}

  .stage{position:fixed;inset:44px 0 0 0;display:grid;grid-template-columns:1fr min(420px,92vw)}
  .board-wrap{position:relative;overflow:hidden}
  canvas#board{
    width:100%;height:100%;display:block;touch-action:none;
    background:
      repeating-linear-gradient(to bottom,
        var(--bg) 0px, var(--bg) 26px,
        var(--line) 26px, var(--line) 27px);
  }
  aside.panel{background:#0b1220;border-left:1px solid #1f2a44;padding:.75rem;overflow:auto}
  .tabs{display:flex;gap:.5rem;margin-bottom:.5rem}
  .tab{padding:.25rem .6rem;border:1px solid #334166;border-radius:.5rem;background:#0b1426;cursor:pointer}
  .tab.active{background:#1b243a}

  .field{display:flex;gap:.5rem;align-items:center;margin:.25rem 0 .75rem}
  .field input{flex:1;padding:.45rem .6rem;border-radius:.45rem;background:#0c1426;color:#e5e7eb;border:1px solid #24314f}
  .pill{font-size:.8rem;padding:.2rem .45rem;border:1px solid #2b3b64;border-radius:999px}
  .list{font-size:.95rem;line-height:1.4}
  .list div.row{display:grid;grid-template-columns:1fr auto auto;gap:.5rem;padding:.35rem .2rem;border-bottom:1px dashed #1c2744}

  .review-card{border:1px solid #25345c;border-radius:.6rem;padding:.5rem;margin:.55rem 0;background:#0e1628}
  .review-head{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem}
  .thumb{width:100%;max-height:220px;object-fit:contain;background:#0a1222;border:1px solid #223253;border-radius:.4rem;cursor:zoom-in}
  .review-actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem}
  .review-actions .btn{padding:.35rem .6rem}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111827;border:1px solid #374151;padding:.6rem .8rem;border-radius:.6rem;z-index:10;display:none}
  .toast.show{display:block}
  #hint{font-size:.85rem;opacity:.9}
  .pen-indicator{position:fixed;left:6px;top:52px;width:34px;height:34px;border-radius:50%;background:#0e1628;border:1px solid #203255;display:grid;place-items:center;z-index:6}
  .pen-indicator:after{content:"✍️";font-size:18px}
</style>
</head>
<body>
  <div class="topbar">
    <strong>Veresia</strong>
    <button id="btnSave" class="btn primary">Запази</button>
    <div class="sep"></div>
    <button id="btnSearch" class="btn">Търсене</button>
    <span id="hint" title="Пише се само със стилус">✍️ Само писалка</span>
  </div>
  <div class="pen-indicator" title="Само със стилус"></div>

  <div class="stage">
    <div class="board-wrap">
      <canvas id="board"></canvas>
    </div>
    <aside id="panel" class="panel" aria-label="панел">
      <div class="tabs">
        <button class="tab active" data-tab="search">Търсене</button>
        <button class="tab" data-tab="review">За преглед</button>
      </div>

      <section id="tab-search">
        <div class="field">
          <input id="q" type="search" placeholder="Име…" list="suggestions" autocomplete="off"/>
          <datalist id="suggestions"></datalist>
          <span id="sum" class="pill">0.00 лв</span>
        </div>
        <div id="rows" class="list" aria-live="polite"></div>
      </section>

      <section id="tab-review" hidden>
        <div id="reviewList"></div>
      </section>
    </aside>
  </div>

  <div id="toast" class="toast"></div>

<script>
/*** КОНФИГ ***/
// Сложи своя Cloud Run адрес; трябва да завършва с /ocr
let OCR_URL = "https://ocr-980985905017.europe-west1.run.app";

/*** IndexedDB ***/
const DB_NAME='veresia-db', STORE='names', REVIEW='review', DB_VER=2;
function withDB(mode,store,fn){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VER);
r.onupgradeneeded=()=>{const db=r.result;
  if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
  if(!db.objectStoreNames.contains(REVIEW)) db.createObjectStore(REVIEW,{autoIncrement:true});
};
r.onerror=()=>rej(r.error);
r.onsuccess=()=>{const tx=r.result.transaction(store,mode);const s=tx.objectStore(store);
Promise.resolve(fn(s)).then(v=>{tx.oncomplete=()=>res(v);tx.onerror=()=>rej(tx.error);},rej);} }) }
const idb={
  get:(k)=>withDB('readonly',STORE,s=>new Promise((res,rej)=>{const r=s.get(k);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)})),
  set:(k,v)=>withDB('readwrite',STORE,s=>new Promise((res,rej)=>{const r=s.put(v,k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})),
  iterateAll:()=>withDB('readonly',STORE,s=>new Promise((res,rej)=>{const out=[];const r=s.openCursor();r.onsuccess=()=>{const c=r.result;if(c){out.push(c.value);c.continue()}else res(out)};r.onerror=()=>rej(r.error)})),
  addReview:(obj)=>withDB('readwrite',REVIEW,s=>new Promise((res,rej)=>{const r=s.add(obj);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)})),
  listReview:()=>withDB('readonly',REVIEW,s=>new Promise((res,rej)=>{const out=[];const r=s.openCursor();r.onsuccess=()=>{const c=r.result;if(c){out.push({id:c.key,...c.value});c.continue()}else res(out)};r.onerror=()=>rej(r.error)})),
  delReview:(id)=>withDB('readwrite',REVIEW,s=>new Promise((res,rej)=>{const r=s.delete(id);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})),
};

/*** UI / Canvas ***/
window.addEventListener('DOMContentLoaded',()=>{
  const canvas=document.getElementById('board');
  const ctx=canvas.getContext('2d',{willReadFrequently:true});
  let drawing=false,last=null;

  function resize(){
    const dpr=window.devicePixelRatio||1;
    const r=canvas.getBoundingClientRect();
    canvas.width=Math.floor(r.width*dpr);
    canvas.height=Math.floor(r.height*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.lineJoin='round';
    ctx.lineCap='round';
    ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--ink').trim()||'#fff';
  }
  window.addEventListener('resize',resize,{passive:true});
  window.addEventListener('orientationchange',()=>setTimeout(resize,50),{passive:true});
  resize();

  const isPen=e=>e.pointerType==='pen';
  const pos=e=>{const r=canvas.getBoundingClientRect();return {x:e.clientX-r.left,y:e.clientY-r.top,p:e.pressure||0.5}};

  canvas.addEventListener('pointerdown',e=>{if(!isPen(e))return;e.preventDefault();drawing=true;last=pos(e)});
  canvas.addEventListener('pointermove',e=>{if(!drawing||!isPen(e))return;const p=pos(e);ctx.lineWidth=2+p.p*3.5;ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;});
  const stop=()=>{drawing=false;last=null};canvas.addEventListener('pointerup',stop);canvas.addEventListener('pointercancel',stop);canvas.addEventListener('pointerleave',stop);

  const toastEl=document.getElementById('toast'); const hint=document.getElementById('hint');
  function toast(m,ms=2400){toastEl.textContent=m;toastEl.classList.add('show');clearTimeout(toastEl._t);toastEl._t=setTimeout(()=>toastEl.classList.remove('show'),ms)}
  const step=t=>{hint.textContent=t};

  async function saveEntry(name,amount){
    const key=name.trim().toLowerCase();
    const prev=await idb.get(key)||{name,total:0,items:[]};
    prev.total=+(prev.total+amount).toFixed(2);
    prev.items.push({amount,ts:Date.now()});
    await idb.set(key,prev);
  }
  async function allEntries(){const rows=await idb.iterateAll();rows.sort((a,b)=>a.name.localeCompare(b.name,'bg'));return rows}

  // Панел / табове
  const panel=document.getElementById('panel');
  const btnSearch=document.getElementById('btnSearch');
  const q=document.getElementById('q');const rowsEl=document.getElementById('rows');const sumEl=document.getElementById('sum');const sugg=document.getElementById('suggestions');
  const tabButtons=[...document.querySelectorAll('.tab')];
  const tabSearch=document.getElementById('tab-search');
  const tabReview=document.getElementById('tab-review');
  const reviewList=document.getElementById('reviewList');

  btnSearch.onclick=async()=>{panel.style.display=panel.style.display?'':'block';resize();if(panel.style.display){await refreshSuggestions();renderSearch(q.value);renderReview()}};
  tabButtons.forEach(b=>b.onclick=()=>{
    tabButtons.forEach(x=>x.classList.remove('active')); b.classList.add('active');
    const t=b.dataset.tab; tabSearch.hidden=(t!=='search'); tabReview.hidden=(t!=='review');
  });

  async function refreshSuggestions(){const rows=await allEntries();sugg.innerHTML='';rows.forEach(r=>{const o=document.createElement('option');o.value=r.name;sugg.appendChild(o)})}
  async function renderSearch(term){
    const t=(term||'').trim().toLowerCase();
    const rows=await allEntries();
    const items=[];
    rows.forEach(r=>{
      if(!t || r.name.toLowerCase().includes(t)){
        r.items.forEach(it=>items.push({name:r.name,amount:it.amount,ts:it.ts}));
      }
    });
    items.sort((a,b)=>a.name.localeCompare(b.name,'bg') || a.ts-b.ts);
    let total=0; rowsEl.innerHTML='';
    items.forEach(x=>{
      total+=x.amount;
      const d=document.createElement('div'); d.className='row';
      const when=new Date(x.ts).toLocaleString('bg-BG',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'});
      d.innerHTML=`<span>${x.name}</span><strong>${x.amount.toFixed(2)} лв</strong><small>${when}</small>`;
      rowsEl.appendChild(d);
    });
    sumEl.textContent=`${total.toFixed(2)} лв`;
  }
  q.addEventListener('input',()=>renderSearch(q.value));

  async function renderReview(){
    const items=await idb.listReview();
    reviewList.innerHTML='';
    items.forEach(item=>{
      const card=document.createElement('div'); card.className='review-card';
      card.innerHTML=`
        <div class="review-head"><strong>#${item.id}</strong><span class="pill">за преглед</span></div>
        <img class="thumb" src="${item.thumb}" alt="ред #${item.id}"/>
        <div class="field" style="margin-top:.5rem">
          <input data-k="name" placeholder="Име (кирилица)"/>
          <input data-k="amount" placeholder="Сума (напр. 2,40)"/>
        </div>
        <div style="font-size:.85rem;opacity:.8">OCR: ${item.text||'—'}</div>
        <div class="review-actions">
          <button class="btn" data-act="confirm">Потвърди</button>
          <button class="btn" data-act="delete">Изтрий</button>
        </div>
      `;
      card.querySelector('.thumb').onclick=()=>{window.open(item.thumb,'_blank')};
      card.querySelector('[data-act="confirm"]').onclick=async()=>{
        const name=card.querySelector('input[data-k="name"]').value.trim();
        const amountRaw=card.querySelector('input[data-k="amount"]').value.trim().replace(' ','');
        const amount = parseAmount(amountRaw);
        if(!name || !/[\p{Script=Cyrillic}]/u.test(name)) return toast('Въведи име на кирилица');
        if(amount==null) return toast('Въведи сума с , или . (напр. 2,40)');
        await saveEntry(name,amount); await idb.delReview(item.id);
        toast('Добавено'); renderSearch(q.value); renderReview();
      };
      card.querySelector('[data-act="delete"]').onclick=async()=>{await idb.delReview(item.id); renderReview()};
      reviewList.appendChild(card);
    });
  }

  function parseAmount(s){
    if(!s) return null;
    s=s.replace(',', '.');
    if(!/^\d+(\.\d{1,2})$/.test(s)) return null; // Искаме ТЕЛЕСЕН разделител, за да избегнем 230 вместо 2,30
    const v=parseFloat(s);
    return Number.isFinite(v)? +v.toFixed(2):null;
  }

  // ——— сегментация: режем редове с мастило и правим мини-изображения
  function splitCanvasToLines(src){
    const dpr=window.devicePixelRatio||1;
    const w=src.width, h=src.height;
    const ctx2=src.getContext('2d',{willReadFrequently:true});
    const img=ctx2.getImageData(0,0,w,h).data;

    // вертикален профил на „мастило“
    const inkRow=new Array(h).fill(0);
    for(let y=0;y<h;y++){
      let acc=0;
      for(let x=0;x<w;x++){
        const i=(y*w+x)*4;
        // при тъмeн фон и светло мастило: пиксел е „мастило“, ако е достатъчно светъл
        const lum=0.299*img[i]+0.587*img[i+1]+0.114*img[i+2];
        if(lum>230) acc++;
      }
      inkRow[y]=acc;
    }
    const TH=Math.max(8, Math.floor(w*0.002)); // праг мастило за ред

    const bands=[];
    let inBand=false, y0=0;
    for(let y=0;y<h;y++){
      if(!inBand && inkRow[y]>TH){inBand=true;y0=y;}
      if(inBand && inkRow[y]<=TH){
        const y1=y;
        if(y1-y0>Math.round(18*dpr)) bands.push([Math.max(0,y0-4*dpr), Math.min(h, y1+4*dpr)]);
        inBand=false;
      }
    }
    if(inBand) bands.push([Math.max(0,y0-4*dpr), h]);

    // към dataURL за всяка лента
    const outs=[];
    const pad=8*dpr;
    bands.forEach(([a,b])=>{
      // хоризонтален bbox в лентата
      let minX=w, maxX=0;
      for(let y=a;y<b;y++){
        for(let x=0;x<w;x++){
          const i=(y*w+x)*4; const lum=0.299*img[i]+0.587*img[i+1]+0.114*img[i+2];
          if(lum>230){ if(x<minX)minX=x; if(x>maxX)maxX=x; }
        }
      }
      if(maxX<=minX) return;
      const cw=Math.min(w, maxX+pad)-Math.max(0,minX-pad);
      const ch=b-a+pad*2;
      const crop=document.createElement('canvas'); crop.width=cw; crop.height=ch;
      const c2=crop.getContext('2d'); c2.drawImage(src, Math.max(0,minX-pad), Math.max(0,a-pad), cw, ch, 0,0,cw,ch);
      outs.push(crop.toDataURL('image/png'));
    });
    return outs;
  }

  async function sendPieces(pieces){
    const payload={ pieces: pieces.map(p=>({imageBase64:p.split(',')[1]})), mode:'line' };
    const r=await fetch(OCR_URL,{method:'POST',mode:'cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const j=await r.json(); if(!r.ok || !j.ok) throw new Error(j?.error||('HTTP '+r.status));
    return j;
  }

  const btnSave=document.getElementById('btnSave');
  btnSave.onclick=async()=>{
    try{
      btnSave.disabled=true;
      // 1) Снимка
      step('Запис: снимка…');
      const blob=await new Promise(r=>canvas.toBlob(b=>r(b),'image/png'));
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download=`veresia-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
      document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove()},0);

      // 2) Сегментация → ленти
      const pieces=splitCanvasToLines(canvas);

      // 3) Нов лист веднага — можеш да пишеш
      const preClear=canvas.getContext('2d'); preClear.clearRect(0,0,canvas.width,canvas.height);

      if(!pieces.length){ toast('Няма текст за OCR'); btnSave.disabled=false; return; }

      step('OCR…');
      const result=await sendPieces(pieces);

      // 4) Сигурни редове
      if(Array.isArray(result.entries)){
        for(const e of result.entries){ await saveEntry(e.name, e.amount); }
      }
      // 5) За преглед
      if(Array.isArray(result.review)){
        for(const r of result.review){
          await idb.addReview({thumb:r.thumb,text:r.text||''});
        }
      }
      toast(`Записани: ${(result.entries||[]).length} • За преглед: ${(result.review||[]).length}`);
      step('Готово');
      renderSearch(q.value); renderReview();
    }catch(err){
      console.error('[OCR]',err);
      toast('OCR грешка'); step('Грешка');
    }finally{ btnSave.disabled=false }
  };

  (async()=>{await refreshSuggestions(); renderReview()})();
});
</script>
</body>
</html>
