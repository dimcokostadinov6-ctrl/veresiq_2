<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Veresia</title>
<style>
  :root{--bg:#0e1116;--line:#1e3558;--ink:#f8fafc;--panel:#0b1220}
  html,body{margin:0;height:100%;background:#0b0f14;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;touch-action:none}
  .topbar{position:fixed;inset:0 0 auto 0;display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:rgba(11,15,20,.65);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:5}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.18);color:#e5e7eb;background:transparent;padding:.45rem .7rem;border-radius:.5rem;font-size:.95rem;cursor:pointer}
  .btn:hover{border-color:#ffffff44}
  .btn.primary{border-color:#60a5fa;background:#1e293b}
  .sep{flex:1}
  .stage{position:fixed;inset:44px 0 0 0;display:grid;grid-template-columns:1fr auto}
  .board-wrap{position:relative;overflow:hidden}
  canvas#board{
    width:100%;height:100%;display:block;touch-action:none;
    background:
      repeating-linear-gradient(to bottom,
        var(--bg) 0px, var(--bg) 26px,
        var(--line) 26px, var(--line) 27px);
  }
  .panel{width:min(480px,96vw);background:var(--panel);border-left:1px solid #1f2a44;padding:.75rem;display:none;overflow:auto}
  .panel.open{display:block}
  .panel h3{margin:.2rem 0 .6rem;font-weight:600}
  .tabs{display:flex;gap:.5rem;margin:.25rem 0 .75rem}
  .tabs button{padding:.3rem .6rem;border:1px solid #2b3b64;background:#0c1426;color:#e5e7eb;border-radius:.45rem;cursor:pointer}
  .tabs button.active{background:#1e293b;border-color:#60a5fa}
  .field{display:flex;gap:.5rem;align-items:center;margin:.25rem 0 .75rem}
  .field input{flex:1;padding:.45rem .6rem;border-radius:.45rem;background:#0c1426;color:#e5e7eb;border:1px solid #24314f}
  .pill{font-size:.8rem;padding:.2rem .45rem;border:1px solid #2b3b64;border-radius:999px}
  .list{font-size:.95rem;line-height:1.4}
  .list div{display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:.4rem;padding:.35rem .2rem;border-bottom:1px dashed #1c2744}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111827;border:1px solid #374151;padding:.6rem .8rem;border-radius:.6rem;z-index:10;display:none}
  .toast.show{display:block}
  #hint{font-size:.85rem;opacity:.9}
  .review-card{border:1px solid #233156;border-radius:.6rem;padding:.6rem;margin:.6rem 0;background:#0d1424}
  .review-head{display:flex;align-items:center;gap:.5rem;margin-bottom:.4rem}
  .thumb{width:100%;max-width:100%;border:1px solid #2a3a60;border-radius:.4rem;background:#0a0f1a}
  .two-cols{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
</style>
</head>
<body>
  <div class="topbar">
    <strong>Veresia</strong>
    <button id="btnSave" class="btn primary">Запази</button>
    <div class="sep"></div>
    <a class="btn" href="./settings.html">Настройки</a>
    <button id="btnSearch" class="btn">Търсене</button>
    <span id="hint" title="Пише се само със стилус">✍️ Само писалка</span>
  </div>

  <div class="stage">
    <div class="board-wrap">
      <canvas id="board"></canvas>
    </div>

    <aside id="side" class="panel" aria-label="Търсене">
      <div class="tabs">
        <button id="tabSearch" class="active">Търсене</button>
        <button id="tabReview">За преглед</button>
      </div>

      <section id="searchView">
        <h3>Търсене</h3>
        <div class="field">
          <input id="q" type="search" placeholder="Име…" list="suggestions" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"/>
          <datalist id="suggestions"></datalist>
          <span id="sum" class="pill">0.00 лв</span>
        </div>
        <div id="rows" class="list" aria-live="polite"></div>
      </section>

      <section id="reviewView" style="display:none">
        <h3>Редове за потвърждение</h3>
        <div id="reviewList"></div>
      </section>
    </aside>
  </div>

  <div id="toast" class="toast"></div>

<script>
/*** КОНФИГ — СЛОЖИ ТВОЯ Cloud Run URL (трябва да завършва на /ocr) ***/
let OCR_URL = "https://ocr-980985905017.europe-west1.run.app/ocr";
if (!/\/ocr\/?$/.test(OCR_URL)) OCR_URL = OCR_URL.replace(/\/?$/, "/ocr");

/*** IndexedDB ***/
const DB_NAME='veresia-db', STORE='names', REVIEW='review', DB_VER=3;
function withDB(mode,fn){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VER);
r.onupgradeneeded=()=>{const db=r.result;
  if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
  if(!db.objectStoreNames.contains(REVIEW)) db.createObjectStore(REVIEW);
};
r.onerror=()=>rej(r.error);
r.onsuccess=()=>{const tx=r.result.transaction([STORE,REVIEW],mode);const s=tx.objectStore(STORE);const rv=tx.objectStore(REVIEW);
Promise.resolve(fn(s,rv)).then(v=>{tx.oncomplete=()=>res(v);tx.onerror=()=>rej(tx.error);},rej);} }) }
const idb={
  get:(k,bag=STORE)=>withDB('readonly',(s,rv)=>new Promise((res,rej)=>{const o=bag===STORE?s:rv;const r=o.get(k);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)})),
  set:(k,v,bag=STORE)=>withDB('readwrite',(s,rv)=>new Promise((res,rej)=>{const o=bag===STORE?s:rv;const r=o.put(v,k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})),
  del:(k,bag=STORE)=>withDB('readwrite',(s,rv)=>new Promise((res,rej)=>{const o=bag===STORE?s:rv;const r=o.delete(k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})),
  iterate:(bag,cb)=>withDB('readonly',(s,rv)=>new Promise((res,rej)=>{const o=bag===STORE?s:rv;const r=o.openCursor();r.onsuccess=()=>{const c=r.result;if(c){cb(c.value,c.key);c.continue()}else res()};r.onerror=()=>rej(r.error)}))
};

/*** UI / Canvas ***/
window.addEventListener('DOMContentLoaded',()=>{
  const canvas=document.getElementById('board');
  const ctx=canvas.getContext('2d',{willReadFrequently:true});
  let drawing=false,last=null;

  function resize(){
    const dpr=window.devicePixelRatio||1;
    const r=canvas.getBoundingClientRect();
    canvas.width=Math.floor(r.width*dpr);
    canvas.height=Math.floor(r.height*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.lineJoin='round';
    ctx.lineCap='round';
    ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--ink').trim()||'#fff';
  }
  window.addEventListener('resize',resize,{passive:true});
  window.addEventListener('orientationchange',()=>setTimeout(resize,50),{passive:true});
  resize();

  const isPen=e=>e.pointerType==='pen';
  const pos=e=>{const r=canvas.getBoundingClientRect();return {x:e.clientX-r.left,y:e.clientY-r.top,p:e.pressure||0.5}};
  canvas.addEventListener('pointerdown',e=>{if(!isPen(e))return;e.preventDefault();drawing=true;last=pos(e)});
  canvas.addEventListener('pointermove',e=>{if(!drawing||!isPen(e))return;const p=pos(e);ctx.lineWidth=2+p.p*3.5;ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;});
  const stop=()=>{drawing=false;last=null};canvas.addEventListener('pointerup',stop);canvas.addEventListener('pointercancel',stop);canvas.addEventListener('pointerleave',stop);

  const toastEl=document.getElementById('toast'); const hint=document.getElementById('hint');
  function toast(m,ms=2600){toastEl.textContent=m;toastEl.classList.add('show');clearTimeout(toastEl._t);toastEl._t=setTimeout(()=>toastEl.classList.remove('show'),ms)}
  const step=t=>{hint.textContent=t};

  async function saveEntry(name,amount){
    const key=name.trim().toLowerCase();
    const prev=await idb.get(key)||{name,total:0,items:[]};
    prev.total=+(prev.total+amount).toFixed(2);
    prev.items.push({amount,ts:Date.now()});
    await idb.set(key,prev);
  }
  async function allEntries(){
    const rows=[]; await idb.iterate(STORE,v=>rows.push(v));
    rows.sort((a,b)=>a.name.localeCompare(b.name,'bg')); return rows;
  }

  const side=document.getElementById('side'),btnSearch=document.getElementById('btnSearch');
  const tabSearch=document.getElementById('tabSearch'),tabReview=document.getElementById('tabReview');
  const searchView=document.getElementById('searchView'),reviewView=document.getElementById('reviewView');
  const q=document.getElementById('q'),rowsEl=document.getElementById('rows'),sumEl=document.getElementById('sum'),sugg=document.getElementById('suggestions');

  function openSearch(){tabSearch.classList.add('active');tabReview.classList.remove('active');searchView.style.display='block';reviewView.style.display='none'}
  function openReview(){tabReview.classList.add('active');tabSearch.classList.remove('active');reviewView.style.display='block';searchView.style.display='none';renderReview()}

  tabSearch.onclick=openSearch; tabReview.onclick=openReview;

  btnSearch.onclick=async()=>{side.classList.toggle('open');resize();if(side.classList.contains('open')){await refreshSuggestions();renderSearch(q.value);q.focus()}};
  async function refreshSuggestions(){const rows=await allEntries();sugg.innerHTML='';rows.forEach(r=>{const o=document.createElement('option');o.value=r.name;sugg.appendChild(o)})}

  async function renderSearch(term){
    const t=(term||'').trim().toLowerCase();
    const rows=await allEntries();
    const items=[];
    rows.forEach(r=>{
      if(!t || r.name.toLowerCase().includes(t)){
        r.items.forEach(it=>items.push({name:r.name,amount:it.amount,ts:it.ts}));
      }
    });
    items.sort((a,b)=>a.name.localeCompare(b.name,'bg') || a.ts-b.ts);
    let total=0; rowsEl.innerHTML='';
    items.forEach(x=>{
      total+=x.amount;
      const d=document.createElement('div');
      const when=new Date(x.ts).toLocaleString('bg-BG',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'});
      d.innerHTML=`<span>${x.name}</span><span>${x.amount.toFixed(2)} лв</span><small>${when}</small>`;
      rowsEl.appendChild(d);
    });
    sumEl.textContent=`${total.toFixed(2)} лв`;
  }
  q.addEventListener('input',()=>renderSearch(q.value));

  /*** „За преглед“ ***/
  const reviewList=document.getElementById('reviewList');
  function nameOnlyCyr(s){return (s||'').replace(/[^\p{Script=Cyrillic}\s.'’-]/gu,'').replace(/\s+/g,' ').trim()}
  function sanitizeAmt(s){
    // стриктно: разрешаваме 12,34 или 12.34 или 12
    const raw=(s||'').replace(/[^\d,.\s]/g,'').replace(/\s+/g,'');
    // ако има точно ЕДНА запетая и НЯМА точка → приемаме като десетичен разделител и обръщаме към точка:
    if(/^\d{1,4},\d{1,2}$/.test(raw)) return +raw.replace(',', '.');
    // ако има точка като десетичен:
    if(/^\d{1,4}\.\d{1,2}$/.test(raw)) return +raw;
    // само цели:
    if(/^\d{1,4}$/.test(raw)) return +raw;
    return NaN;
  }
  async function renderReview(){
    reviewList.innerHTML='';
    const items=[];
    await idb.iterate(REVIEW,(v,k)=>items.push({...v,id:k}));
    if(!items.length){reviewList.innerHTML='<p>Няма чакащи редове.</p>';return;}
    for(const item of items){
      const card=document.createElement('div'); card.className='review-card';
      card.innerHTML=`
        <div class="review-head"><strong>#${item.id}</strong><span class="pill">за преглед</span></div>
        <img class="thumb" alt="Фрагмент" src="${item.thumb}"/>
        <div class="two-cols" style="margin-top:.5rem">
          <label>Име (кирилица)
            <input class="name" value="${item.name||''}" autocapitalize="off" autocorrect="off" spellcheck="false" />
          </label>
          <label>Сума
            <input class="sum" value="${item.amount??''}" inputmode="decimal" />
          </label>
        </div>
        <small>OCR: ${(item.ocrRaw||'')}</small>
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.5rem">
          <button class="btn" data-act="del">Изтрий</button>
          <button class="btn primary" data-act="ok">Потвърди</button>
        </div>
      `;
      reviewList.appendChild(card);

      const nameEl=card.querySelector('.name');
      const sumEl=card.querySelector('.sum');
      card.addEventListener('click',async(ev)=>{
        const act=ev.target?.getAttribute?.('data-act');
        if(!act) return;
        if(act==='del'){ await idb.del(item.id,REVIEW); renderReview(); return; }
        if(act==='ok'){
          const name=nameOnlyCyr(nameEl.value);
          const amount=sanitizeAmt(sumEl.value);
          if(!name || !Number.isFinite(amount)){alert('Попълни валидни име и сума (напр. 2,30 или 2.30).');return;}
          await saveEntry(name,amount);
          await idb.del(item.id,REVIEW);
          renderReview();
          toast(`Добавено: ${name} – ${amount.toFixed(2)} лв`);
          await refreshSuggestions(); renderSearch(q.value);
        }
      });
    }
  }

  /*** Подготовка за OCR + сегментация по редове ***/
  function toBW(src){
    const dpr=window.devicePixelRatio||1, scale=3;
    const w=Math.floor(src.width/dpr*scale), h=Math.floor(src.height/dpr*scale);
    const out=document.createElement('canvas'); out.width=w; out.height=h;
    const o=out.getContext('2d',{willReadFrequently:true});
    o.drawImage(src,0,0,w,h);
    let img=o.getImageData(0,0,w,h), d=img.data;
    // Премахване на линии/фон, оставяме мастилото черно
    for(let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      const bright=r+g+b;
      const isBlue = b>60 && b>r+20 && b>g+10; // линиите
      if(isBlue){ d[i]=d[i+1]=d[i+2]=255; continue; }
      // всичко друго: прагове към черно-бяло
      const gray=(r*0.2126+g*0.7152+b*0.0722);
      const v = gray<170 ? 0 : 255;
      d[i]=d[i+1]=d[i+2]=v; d[i+3]=255;
    }
    o.putImageData(img,0,0);
    return out;
  }

  function segmentRows(bwCanvas){
    const w=bwCanvas.width, h=bwCanvas.height;
    const g=bwCanvas.getContext('2d').getImageData(0,0,w,h).data;
    const rows=[]; let inBand=false, start=0;
    for(let y=0;y<h;y++){
      let dark=0;
      for(let x=0;x<w;x++) if(g[(y*w+x)*4]===0) dark++;
      const inkRatio = dark / w;
      if(!inBand && inkRatio>0.012){ inBand=true; start=y; }
      if(inBand && inkRatio<0.004){
        const end=y;
        if(end-start>22) rows.push([Math.max(0,start-4), Math.min(h,end+4)]);
        inBand=false;
      }
    }
    if(inBand) rows.push([Math.max(0,start-4), h-1]);

    const ctx=bwCanvas.getContext('2d');
    return rows.map(([y0,y1],i)=>{
      const ch=y1-y0+1;
      const crop=document.createElement('canvas'); crop.width=w; crop.height=ch;
      crop.getContext('2d').drawImage(bwCanvas,0,y0,w,ch,0,0,w,ch);
      const thumb=document.createElement('canvas'); const scale=Math.min(1,420/w);
      thumb.width=Math.floor(w*scale); thumb.height=Math.floor(ch*scale);
      thumb.getContext('2d').drawImage(crop,0,0,thumb.width,thumb.height);
      return {id:Date.now()+i, data:crop.toDataURL('image/png'), thumb:thumb.toDataURL('image/png')};
    });
  }

  /*** Заявка към OCR с retry/timeout ***/
  async function fetchJSON(url, options={}, timeoutMs=15000, retries=2){
    for(let attempt=0; attempt<=retries; attempt++){
      const ctrl=new AbortController();
      const t=setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const r=await fetch(url,{...options,signal:ctrl.signal});
        clearTimeout(t);
        const j=await r.json().catch(()=> ({}));
        if(!r.ok) throw new Error(j?.error || ('HTTP '+r.status));
        return j;
      }catch(e){
        clearTimeout(e);
        if(attempt===retries) throw e;
        await new Promise(r=>setTimeout(r, 400*(attempt+1)));
      }
    }
  }
  async function sendLineToOCR(slice){
    const base64 = slice.data.split(',')[1];
    return fetchJSON(OCR_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ imageBase64: base64 })
    });
  }

  // резервно парсване (само кирилица)
  function pickPairs(text){
    const results=[];
    if(!text) return results;
    const norm = (s)=>s.normalize('NFC').replace(/[–—−]/g,'-').replace(/\u00A0/g,' ');
    // позволяваме „Име - 2,30“ или „Име: 2.30“ или „Име = 2“
    const rx=/([\p{Script=Cyrillic}\s.'’-]{2,50})\s*[-=:]\s*([0-9]{1,4}(?:[.,][0-9]{1,2})?)/gu;
    for(const line of norm(text).split(/\r?\n/)){
      let m; while((m=rx.exec(line))!==null){
        const name = m[1].replace(/[^\p{Script=Cyrillic}\s.'’-]/gu,' ').replace(/\s+/g,' ').trim();
        // стриктни правила за сумата, за да не правим 2,30 -> 230
        const raw = String(m[2]).replace(/\s+/g,'');
        if(!/^\d{1,4}([.,]\d{1,2})?$/.test(raw)) continue;
        const amt = parseFloat(raw.replace(',', '.'));
        if(name && Number.isFinite(amt)) results.push({name,amount:+amt.toFixed(2)});
      }
    }
    return results;
  }

  async function processSlices(slices){
    let okCount=0, pushToReview=0;
    for(const s of slices){
      try{
        const resp=await sendLineToOCR(s);
        // 1) ползвай сървърните entries; 2) fallback към локалния парсер
        const entries = (Array.isArray(resp.entries) && resp.entries.length)
          ? resp.entries
          : pickPairs(resp.text);
        if(entries.length){
          for(const e of entries) await saveEntry(e.name,e.amount);
          okCount+=entries.length;
        }else{
          await idb.set(String(s.id), {thumb:s.thumb, ocrRaw:(resp.text||'').slice(0,160), name:'', amount:'', ts:Date.now()}, REVIEW);
          pushToReview++;
        }
      }catch(err){
        console.error('[OCR slice]',err);
        await idb.set(String(s.id), {thumb:s.thumb, ocrRaw:'(грешка)', name:'', amount:'', ts:Date.now()}, REVIEW);
        pushToReview++;
      }
    }
    if(okCount) toast(`Записани редове: ${okCount}`);
    if(pushToReview) toast(`За преглед: ${pushToReview}`);
    if(side.classList.contains('open') && tabReview.classList.contains('active')) renderReview();
    await refreshSuggestions(); renderSearch(q.value);
  }

  /*** Запази ***/
  const btnSave=document.getElementById('btnSave');
  btnSave.onclick=async()=>{
    try{
      // 1) снимка
      step('Запис: снимка…');
      const blob=await new Promise(r=>canvas.toBlob(b=>r(b),'image/png'));
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download=`veresia-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
      document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove()},0);

      // 2) черно/бяло и сегментация
      const bw=toBW(canvas);
      const slices=segmentRows(bw);

      // 3) нов лист веднага (можеш да пишеш)
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // 4) OCR асинхронно
      void processSlices(slices);
      step('Готово (OCR работи във фона)');
    }catch(err){ console.error(err); toast('Грешка при „Запази“'); step('Грешка'); }
  };

  (async()=>{await refreshSuggestions()})();
});
</script>
</body>
</html>
