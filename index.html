<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Veresia</title>
<style>
  :root{--bg:#0e1116;--line:#1e3558;--ink:#f8fafc;--muted:#97a3b3;--yellow:#f59e0b}
  html,body{margin:0;height:100%;background:#0b0f14;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;touch-action:none}
  .topbar{position:fixed;inset:0 0 auto 0;display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:rgba(11,15,20,.65);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:5}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.18);color:#e5e7eb;background:transparent;padding:.45rem .7rem;border-radius:.5rem;font-size:.95rem;cursor:pointer}
  .btn:hover{border-color:#ffffff44}
  .btn.primary{border-color:#60a5fa;background:#1e293b}
  .sep{flex:1}
  .stage{position:fixed;inset:44px 0 0 0;display:grid;grid-template-columns:1fr auto}
  .board-wrap{position:relative;overflow:hidden}
  canvas#board{
    width:100%;height:100%;display:block;touch-action:none;
    background:
      repeating-linear-gradient(to bottom,
        var(--bg) 0px, var(--bg) 26px,
        var(--line) 26px, var(--line) 27px);
  }
  .panel{width:min(420px,94vw);background:#0b1220;border-left:1px solid #1f2a44;padding:.75rem;display:none}
  .panel.open{display:block}
  .tabs{display:flex;gap:.4rem;margin-bottom:.5rem}
  .tab{padding:.35rem .6rem;border:1px solid #223255;border-radius:.45rem;cursor:pointer}
  .tab[aria-selected="true"]{background:#132036}
  .section{display:none}
  .section.open{display:block}
  .hflex{display:flex;gap:.5rem;align-items:center}
  .field{display:flex;gap:.5rem;align-items:center;margin:.25rem 0 .75rem}
  .field input{flex:1;padding:.45rem .6rem;border-radius:.45rem;background:#0c1426;color:#e5e7eb;border:1px solid #24314f}
  .pill{font-size:.8rem;padding:.2rem .45rem;border:1px solid #2b3b64;border-radius:999px}
  .list{font-size:.95rem;line-height:1.4;max-height:calc(100vh - 200px);overflow:auto}
  .row{display:grid;grid-template-columns:1fr auto;gap:.6rem;padding:.35rem .2rem;border-bottom:1px dashed #1c2744}
  .muted{color:#9aa6b6}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111827;border:1px solid #374151;padding:.6rem .8rem;border-radius:.6rem;z-index:10;display:none}
  .toast.show{display:block}
  #hint{font-size:.85rem;opacity:.9}
  .pen-indicator{position:fixed;left:6px;top:52px;width:34px;height:34px;border-radius:50%;background:#0e1628;border:1px solid #203255;display:grid;place-items:center;z-index:6}
  .pen-indicator:after{content:"✍️";font-size:18px}
  .rev-row{display:grid;grid-template-columns:56px 1fr auto;gap:.5rem;padding:.45rem 0;border-bottom:1px dashed #1c2744}
  .rev-row img{width:56px;height:32px;object-fit:contain;background:#0c1426;border:1px solid #223255;border-radius:.25rem}
  .rev-row input{padding:.35rem .5rem;border-radius:.4rem;background:#0c1426;color:#e5e7eb;border:1px solid #24314f}
  .rev-row .actions{display:flex;gap:.35rem;align-items:center}
  .rev-row .btn{padding:.35rem .55rem;font-size:.85rem}
  .tag{font-size:.75rem;color:#111827;background:var(--yellow);border-radius:.35rem;padding:.1rem .3rem}
</style>
</head>
<body>
  <div class="topbar">
    <strong>Veresia</strong>
    <button id="btnSave" class="btn primary">Запази</button>
    <div class="sep"></div>
    <button id="btnSearch" class="btn">Търсене</button>
    <span id="hint" title="Пише се само със стилус">✍️ Само писалка</span>
  </div>
  <div class="pen-indicator" title="Само със стилус"></div>

  <div class="stage">
    <div class="board-wrap">
      <canvas id="board"></canvas>
    </div>

    <aside id="side" class="panel" aria-label="Страничен панел">
      <div class="tabs">
        <button class="tab" id="tabSearch" aria-selected="true">Търсене</button>
        <button class="tab" id="tabReview" aria-selected="false">За преглед</button>
      </div>

      <!-- Търсене -->
      <section id="secSearch" class="section open">
        <div class="field">
          <input id="q" type="search" placeholder="Име…" list="suggestions" autocomplete="off"/>
          <datalist id="suggestions"></datalist>
        </div>
        <div class="hflex" style="justify-content:space-between;margin-bottom:.5rem">
          <span class="pill" id="sumOk">Сигурни: 0.00 лв</span>
          <span class="pill" id="sumReview" title="редове за потвърждение">За преглед: 0.00 лв</span>
        </div>
        <div id="rows" class="list" aria-live="polite"></div>
      </section>

      <!-- За преглед -->
      <section id="secReview" class="section">
        <div class="hflex" style="justify-content:space-between;margin:.2rem 0 .5rem">
          <strong>Редове за потвърждение</strong>
          <span class="muted" id="revCount">0</span>
        </div>
        <div id="revList" class="list" aria-live="polite"></div>
      </section>
    </aside>
  </div>

  <div id="toast" class="toast"></div>

<script>
/*** КОНФИГ: Cloud Run URL (без /ocr — добавяме го) ***/
let OCR_URL = "https://ocr-980985905017.europe-west1.run.app";
if (!/\/ocr\/?$/.test(OCR_URL)) OCR_URL = OCR_URL.replace(/\/?$/, "/ocr");
const OCR_BATCH_URL = OCR_URL.replace(/\/ocr\/?$/, "/ocr-batch");

/*** IndexedDB: names (основни), review (за потвърждение) ***/
const DB_NAME='veresia-db', DB_VER=2, STORE_NAMES='names', STORE_REVIEW='review';
function withDB(mode, store, fn){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(DB_NAME,DB_VER);
    r.onupgradeneeded=()=>{const db=r.result;
      if(!db.objectStoreNames.contains(STORE_NAMES)) db.createObjectStore(STORE_NAMES);
      if(!db.objectStoreNames.contains(STORE_REVIEW)) db.createObjectStore(STORE_REVIEW,{keyPath:'id',autoIncrement:true});
    };
    r.onerror=()=>rej(r.error);
    r.onsuccess=()=>{const tx=r.result.transaction(store,mode);const s=tx.objectStore(store);
      Promise.resolve(fn(s)).then(v=>{tx.oncomplete=()=>res(v);tx.onerror=()=>rej(tx.error)},rej)};
  });
}
const dbNames={
  get:k=>withDB('readonly',STORE_NAMES,s=>new Promise((res,rej)=>{const r=s.get(k);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)})),
  set:(k,v)=>withDB('readwrite',STORE_NAMES,s=>new Promise((res,rej)=>{const r=s.put(v,k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})),
  each:(cb)=>withDB('readonly',STORE_NAMES,s=>new Promise((res,rej)=>{const c=s.openCursor();c.onsuccess=()=>{const k=c.result;if(k){cb(k.value,k.key);k.continue()}else res()};c.onerror=()=>rej(c.error)}))
};
const dbReview={
  add:(v)=>withDB('readwrite',STORE_REVIEW,s=>new Promise((res,rej)=>{const r=s.add(v);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)})),
  del:(id)=>withDB('readwrite',STORE_REVIEW,s=>new Promise((res,rej)=>{const r=s.delete(id);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})),
  all:()=>withDB('readonly',STORE_REVIEW,s=>new Promise((res,rej)=>{const arr=[];const c=s.openCursor();c.onsuccess=()=>{const k=c.result;if(k){arr.push(k.value);k.continue()}else res(arr)};c.onerror=()=>rej(c.error)}))
};

/*** UI / CANVAS ***/
window.addEventListener('DOMContentLoaded',()=>{
  const canvas=document.getElementById('board');
  const ctx=canvas.getContext('2d',{willReadFrequently:true});
  let drawing=false,last=null;

  function resize(){const dpr=devicePixelRatio||1;const r=canvas.getBoundingClientRect();
    canvas.width=Math.floor(r.width*dpr);canvas.height=Math.floor(r.height*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);ctx.lineJoin='round';ctx.lineCap='round';
    ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--ink').trim()||'#fff';
  }
  addEventListener('resize',resize,{passive:true}); addEventListener('orientationchange',()=>setTimeout(resize,50),{passive:true}); resize();

  const isPen=e=>e.pointerType==='pen';
  const pxy=e=>{const r=canvas.getBoundingClientRect();return {x:e.clientX-r.left,y:e.clientY-r.top,p:e.pressure||0.5}};

  canvas.addEventListener('pointerdown',e=>{if(!isPen(e))return;e.preventDefault();drawing=true;last=pxy(e)});
  canvas.addEventListener('pointermove',e=>{if(!drawing||!isPen(e))return;const p=pxy(e);ctx.lineWidth=2+p.p*3.5;ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;});
  const stop=()=>{drawing=false;last=null}; canvas.addEventListener('pointerup',stop); canvas.addEventListener('pointercancel',stop); canvas.addEventListener('pointerleave',stop);

  const toastEl=document.getElementById('toast'); const hint=document.getElementById('hint');
  function toast(m,ms=2400){toastEl.textContent=m;toastEl.classList.add('show');clearTimeout(toastEl._t);toastEl._t=setTimeout(()=>toastEl.classList.remove('show'),ms)}
  const step=t=>{hint.textContent=t};

  /*** Основна база: записване на сигурен ред ***/
  async function saveEntry(name,amount){
    const key=name.trim().toLowerCase();
    const rec=(await dbNames.get(key))||{name,total:0,items:[]};
    rec.total=+(rec.total+amount).toFixed(2);
    rec.items.push({amount,ts:Date.now()});
    await dbNames.set(key,rec);
  }

  /*** Списъци за търсене ***/
  async function allRowsFlat(){
    const rows=[]; await dbNames.each(rec=>{for(const it of rec.items) rows.push({name:rec.name,amount:it.amount,ts:it.ts})});
    rows.sort((a,b)=>a.name.localeCompare(b.name,'bg') || a.ts-b.ts);
    return rows;
  }

  /*** Преглед: добавяне/изтриване/потвърждаване ***/
  async function addReview(item){ return await dbReview.add(item); }
  async function delReview(id){ return await dbReview.del(id); }
  async function listReview(){ return await dbReview.all(); }
  async function confirmReview(id, name, amount){
    const v=parseFloat(String(amount).replace(',', '.'));
    if(!name || !Number.isFinite(v)) throw new Error('Невалидни данни');
    await saveEntry(name, +v.toFixed(2));
    await delReview(id);
  }

  /*** Търсене UI ***/
  const side=document.getElementById('side'), btnSearch=document.getElementById('btnSearch');
  const tabSearch=document.getElementById('tabSearch'), tabReview=document.getElementById('tabReview');
  const secSearch=document.getElementById('secSearch'), secReview=document.getElementById('secReview');
  const q=document.getElementById('q'), rowsEl=document.getElementById('rows'), sugg=document.getElementById('suggestions');
  const sumOkEl=document.getElementById('sumOk'), sumReviewEl=document.getElementById('sumReview');
  const revList=document.getElementById('revList'), revCount=document.getElementById('revCount');

  function openTab(which){
    const isSearch = which==='search';
    tabSearch.setAttribute('aria-selected', isSearch?'true':'false');
    tabReview.setAttribute('aria-selected', !isSearch?'true':'false');
    secSearch.classList.toggle('open', isSearch);
    secReview.classList.toggle('open', !isSearch);
  }
  tabSearch.onclick=()=>openTab('search');
  tabReview.onclick=()=>openTab('review');

  btnSearch.onclick=async()=>{
    side.classList.toggle('open'); resize();
    if(side.classList.contains('open')){
      await refreshSuggestions(); await renderSearch(q.value); await renderReview();
      q.focus();
    }
  };

  async function refreshSuggestions(){
    sugg.innerHTML=''; const seen=new Set();
    await dbNames.each(rec=>{ if(!seen.has(rec.name)){ seen.add(rec.name); const o=document.createElement('option'); o.value=rec.name; sugg.appendChild(o); } });
  }

  async function renderSearch(term){
    const t=(term||'').trim().toLowerCase();
    const rows = await allRowsFlat();
    rowsEl.innerHTML=''; let sumOk=0;
    for(const r of rows){ if(t && !r.name.toLowerCase().includes(t)) continue;
      sumOk += r.amount;
      const d=document.createElement('div'); d.className='row';
      const when=new Date(r.ts).toLocaleString('bg-BG',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'});
      d.innerHTML=`<div><strong>${r.name}</strong><div class="muted">${when}</div></div><div><strong>${r.amount.toFixed(2)} лв</strong></div>`;
      rowsEl.appendChild(d);
    }
    // сума за преглед (ориентировъчно: предложените суми, ако има)
    const rev = await listReview();
    const sumRev = rev.reduce((s,x)=> s + (Number.isFinite(+x.suggestedAmount)? +(+x.suggestedAmount).toFixed(2) : 0), 0);
    sumOkEl.textContent = `Сигурни: ${sumOk.toFixed(2)} лв`;
    sumReviewEl.textContent = `За преглед: ${sumRev.toFixed(2)} лв`;
  }
  q.addEventListener('input',()=>renderSearch(q.value));

  async function renderReview(){
    const items = await listReview();
    revCount.textContent = String(items.length);
    revList.innerHTML = '';
    for(const it of items){
      const row=document.createElement('div'); row.className='rev-row';
      const img=document.createElement('img'); img.src=it.image; img.alt='ред';
      const nameInp=document.createElement('input'); nameInp.placeholder='Име (кирилица)'; nameInp.value=it.suggestedName||'';
      const amtInp=document.createElement('input'); amtInp.placeholder='Сума'; amtInp.inputMode='decimal'; amtInp.value=(Number.isFinite(+it.suggestedAmount)? (+it.suggestedAmount).toFixed(2) : '');
      const info=document.createElement('div'); info.className='muted'; info.style.fontSize='.8rem'; info.textContent = it.rawText ? `OCR: ${it.rawText}` : 'OCR: (без текст)';
      const left=document.createElement('div'); left.appendChild(nameInp); left.appendChild(amtInp); left.appendChild(info);

      const okBtn=document.createElement('button'); okBtn.className='btn'; okBtn.textContent='✅ Потвърди';
      okBtn.onclick=async()=>{
        try{ await confirmReview(it.id, nameInp.value, amtInp.value); toast('Записано'); await renderReview(); await renderSearch(q.value); }
        catch(e){ console.error(e); toast('Грешка при потвърждаване'); }
      };
      const delBtn=document.createElement('button'); delBtn.className='btn'; delBtn.textContent='🗑️ Изтрий';
      delBtn.onclick=async()=>{ try{ await delReview(it.id); toast('Изтрито'); await renderReview(); } catch(e){ console.error(e); toast('Грешка при изтриване'); } };
      const actions=document.createElement('div'); actions.className='actions'; actions.appendChild(okBtn); actions.appendChild(delBtn);

      row.appendChild(img);
      row.appendChild(left);
      const right=document.createElement('div');
      const tag=document.createElement('span'); tag.className='tag'; tag.textContent='за преглед';
      right.appendChild(tag); right.appendChild(document.createElement('div')); right.appendChild(actions);
      row.appendChild(right);

      revList.appendChild(row);
    }
  }

  /*** Обработка на изображение + сегментация на РЕДОВЕ ***/
  function makeBinary(src){
    const dpr=devicePixelRatio||1, scale=5;
    const w=Math.floor(src.width/dpr*scale), h=Math.floor(src.height/dpr*scale);
    const out=document.createElement('canvas'); out.width=w; out.height=h;
    const o=out.getContext('2d',{willReadFrequently:true}); o.drawImage(src,0,0,w,h);

    // към сиво + премахване на сини линии
    const img=o.getImageData(0,0,w,h), d=img.data;
    for(let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      const blue = b>60 && b>r+20 && b>g+10; if (blue){ d[i]=d[i+1]=d[i+2]=255; d[i+3]=255; continue; }
      const y=0.299*r+0.587*g+0.114*b; d[i]=d[i+1]=d[i+2]=y; d[i+3]=255;
    }
    o.putImageData(img,0,0);

    // медианен 3x3
    const srcData=o.getImageData(0,0,w,h), S=srcData.data;
    const dstData=o.createImageData(w,h), D=dstData.data;
    const kx=[-1,0,1], ky=[-1,0,1]; const win=new Uint8Array(9);
    for(let y=1;y<h-1;y++){
      for(let x=1;x<w-1;x++){
        let idx=0;
        for(let yy of ky){ for(let xx of kx){ win[idx++]=S[((y+yy)*w+(x+xx))*4]; } }
        win.sort((a,b)=>a-b);
        const med=win[4]; const i=(y*w+x)*4; D[i]=D[i+1]=D[i+2]=med; D[i+3]=255;
      }
    }
    o.putImageData(dstData,0,0);

    // адаптивен праг по ленти
    const g=o.getImageData(0,0,w,h), G=g.data, band=32;
    for(let y=0;y<h;y+=band){
      const y2=Math.min(h,y+band); let sum=0, n=0;
      for(let yy=y;yy<y2;yy++){ for(let x=0;x<w;x++){ sum+=G[(yy*w+x)*4]; n++; } }
      const mean=sum/n, T=mean-12;
      for(let yy=y;yy<y2;yy++){ for(let x=0;x<w;x++){
        const i=(yy*w+x)*4, v=G[i]<T?0:255; G[i]=G[i+1]=G[i+2]=v; G[i+3]=255;
      } }
    }
    o.putImageData(g,0,0);
    return out;
  }

  function segmentLines(bin){
    const w=bin.width,h=bin.height, ctxb=bin.getContext('2d',{willReadFrequently:true});
    const { data }=ctxb.getImageData(0,0,w,h);
    const rowSum=new Uint32Array(h);
    for(let y=0;y<h;y++){ let s=0,off=y*w*4; for(let x=0;x<w;x++){ if(data[off]===0)s++; off+=4; } rowSum[y]=s; }
    const thresh=Math.max(10,Math.floor(w*0.012));
    const boxes=[]; let inRun=false,y0=0;
    for(let y=0;y<h;y++){
      if(!inRun && rowSum[y]>thresh){ inRun=true;y0=y; }
      else if(inRun && rowSum[y]<=thresh){ const y1=y-1; if(y1-y0>8) boxes.push({x:0,y:Math.max(0,y0-4),w:w,h:Math.min(h-1,y1+4)-Math.max(0,y0-4)+1}); inRun=false; }
    }
    if(inRun){ const y1=h-1; if(y1-y0>8) boxes.push({x:0,y:Math.max(0,y0-4),w:w,h:Math.min(h-1,y1+4)-Math.max(0,y0-4)+1}); }

    const lines=[]; // {id, base64, imageDataURL}
    for (let i=0;i<boxes.length;i++){
      const b=boxes[i], c=document.createElement('canvas'); c.width=b.w; c.height=b.h;
      c.getContext('2d').drawImage(bin,b.x,b.y,b.w,b.h,0,0,b.w,b.h);
      const dataURL=c.toDataURL('image/png');
      lines.push({ id:`L${Date.now()}_${i}`, base64:dataURL.split(',')[1], dataURL });
    }
    return lines;
  }

  async function sendBatch(items){
    const payload = { images: items.map(x=>({id:x.id,imageBase64:x.base64})) };
    const r=await fetch(OCR_BATCH_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok) throw new Error(`HTTP ${r.status}`); return await r.json();
  }

  // ==== Запази ====
  const btnSave=document.getElementById('btnSave');
  btnSave.onclick=async()=>{
    try{
      step('Запис: снимка…');
      // 1) PNG на целия лист
      const blob=await new Promise(r=>canvas.toBlob(b=>r(b),'image/png'));
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`veresia-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
      document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url);a.remove()},0);

      // 2) Сегментация на редове
      const bin=makeBinary(canvas);
      const lines=segmentLines(bin); // [{id,base64,dataURL},...]

      // 3) Чистим платното — пишеш нов лист веднага
      ctx.clearRect(0,0,canvas.width,canvas.height);

      if(!lines.length){ toast('Не открих редове. Пиши по линиите / по-едро.'); return; }

      // 4) OCR на заден фон
      step('OCR…');
      (async()=>{
        try{
          const resp = await sendBatch(lines.map(x=>({id:x.id, base64:x.base64})));
          const byId = Object.fromEntries(lines.map(x=>[x.id,x]));
          let okCount=0, reviewCount=0;

          for(const e of (resp?.entries||[])){
            const src = byId[e.id];
            if (!src) continue;

            if (e.ok && e.name && Number.isFinite(+e.amount)) {
              await saveEntry(e.name, +(+e.amount).toFixed(2));
              okCount++;
            } else {
              await addReview({
                image: src.dataURL,
                rawText: e.rawText || '',
                suggestedName: (e.name||''),
                suggestedAmount: (Number.isFinite(+e.amount)? +(+e.amount).toFixed(2) : ''),
                confidence: typeof e.confidence==='number'? e.confidence : null,
                ts: Date.now()
              });
              reviewCount++;
            }
          }
          if (okCount || reviewCount){
            toast(`Готово: ${okCount} записани, ${reviewCount} за преглед`);
            await refreshSuggestions(); await renderSearch(q.value); await renderReview();
          } else {
            toast('Не открих „Име - сума“. Пример: Иван - 2,30');
          }
          step('Готово');
        }catch(err){ console.error('[OCR]',err); toast('OCR грешка (виж конзолата)'); step('Грешка'); }
      })();

    }catch(err){ console.error(err); toast('Грешка при „Запази“'); }
  };

  // първоначално
  (async()=>{ await refreshSuggestions(); await renderSearch(''); })();

});
</script>
</body>
</html>
