<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Veresia</title>
<style>
:root{--bg:#0e1116;--line:#1e3558;--ink:#f8fafc}
html,body{margin:0;height:100%;background:#0b0f14;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;touch-action:none}
.topbar{position:fixed;inset:0 0 auto 0;display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:rgba(11,15,20,.65);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:5}
.btn{appearance:none;border:1px solid rgba(255,255,255,.18);color:#e5e7eb;background:transparent;padding:.45rem .7rem;border-radius:.5rem;font-size:.95rem;cursor:pointer}
.btn:hover{border-color:#ffffff44}
.btn.primary{border-color:#60a5fa;background:#1e293b}
.sep{flex:1}
.stage{position:fixed;inset:44px 0 0 0;display:grid;grid-template-columns:1fr auto}
.board-wrap{position:relative;overflow:hidden}
canvas#board{
  width:100%;height:100%;display:block;touch-action:none;
  background:repeating-linear-gradient(to bottom,var(--bg) 0px,var(--bg) 26px,var(--line) 26px,var(--line) 27px);
}
.panel{width:min(360px,92vw);background:#0b1220;border-left:1px solid #1f2a44;padding:.75rem;display:none}
.panel.open{display:block}
.panel h3{margin:.2rem 0 .6rem;font-weight:600}
.field{display:flex;gap:.5rem;align-items:center;margin:.25rem 0 .75rem}
.field input{flex:1;padding:.45rem .6rem;border-radius:.45rem;background:#0c1426;color:#e5e7eb;border:1px solid #24314f}
.pill{font-size:.8rem;padding:.2rem .45rem;border:1px solid #2b3b64;border-radius:999px}
.list{font-size:.95rem;line-height:1.4}
.list div{display:flex;justify-content:space-between;padding:.35rem .2rem;border-bottom:1px dashed #1c2744}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111827;border:1px solid #374151;padding:.6rem .8rem;border-radius:.6rem;z-index:10;display:none}
.toast.show{display:block}
#hint{font-size:.85rem;opacity:.9}
</style>
</head>
<body>
<div class="topbar">
  <strong>Veresia</strong>
  <button id="btnSave" class="btn primary">Запази</button>
  <div class="sep"></div>
  <button id="btnSearch" class="btn">Търсене</button>
  <span id="hint">✍️ Само писалка</span>
</div>
<div class="stage">
  <div class="board-wrap"><canvas id="board"></canvas></div>
  <aside id="searchPanel" class="panel">
    <h3>Търсене</h3>
    <div class="field">
      <input id="q" type="search" placeholder="Име…" list="suggestions" autocomplete="off"/>
      <datalist id="suggestions"></datalist>
      <span id="sum" class="pill">0.00 лв</span>
    </div>
    <div id="rows" class="list"></div>
  </aside>
</div>
<div id="toast" class="toast"></div>

<script>
const OCR_URL = "https://ocr-980985905017.europe-west1.run.app"; // твоя backend
const DB_NAME='veresia-db', STORE='names', DB_VER=1;

function withDB(mode,fn){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VER);
r.onupgradeneeded=()=>{const db=r.result;if(!db.objectStoreNames.contains(STORE))db.createObjectStore(STORE,{autoIncrement:true});};
r.onerror=()=>rej(r.error);r.onsuccess=()=>{const tx=r.result.transaction(STORE,mode);const s=tx.objectStore(STORE);
Promise.resolve(fn(s)).then(v=>{tx.oncomplete=()=>res(v);tx.onerror=()=>rej(tx.error)},rej)}});}
const idb={
  add:v=>withDB('readwrite',s=>new Promise((res,rej)=>{const r=s.add(v);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})),
  all:()=>withDB('readonly',s=>new Promise((res,rej)=>{const arr=[];const r=s.openCursor();r.onsuccess=()=>{const c=r.result;if(c){arr.push(c.value);c.continue()}else res(arr)};r.onerror=()=>rej(r.error)}))
};

window.addEventListener('DOMContentLoaded',()=>{
  const canvas=document.getElementById('board');
  const ctx=canvas.getContext('2d',{willReadFrequently:true});
  function resize(){const dpr=window.devicePixelRatio||1;const r=canvas.getBoundingClientRect();
    canvas.width=r.width*dpr;canvas.height=r.height*dpr;ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.lineJoin='round';ctx.lineCap='round';ctx.strokeStyle='#f8fafc';}
  resize();window.addEventListener('resize',resize);
  const isPen=e=>e.pointerType==='pen';
  let drawing=false,last=null;
  const pos=e=>{const r=canvas.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top}};
  canvas.addEventListener('pointerdown',e=>{if(!isPen(e))return;e.preventDefault();drawing=true;last=pos(e)});
  canvas.addEventListener('pointermove',e=>{if(!drawing||!isPen(e))return;const p=pos(e);ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;});
  const stop=()=>drawing=false;canvas.addEventListener('pointerup',stop);canvas.addEventListener('pointerleave',stop);

  const toastEl=document.getElementById('toast');
  const toast=m=>{toastEl.textContent=m;toastEl.classList.add('show');clearTimeout(toastEl._t);toastEl._t=setTimeout(()=>toastEl.classList.remove('show'),2200);};

  const panel=document.getElementById('searchPanel');
  const btnSearch=document.getElementById('btnSearch');
  const q=document.getElementById('q');
  const rowsEl=document.getElementById('rows');
  const sumEl=document.getElementById('sum');
  const sugg=document.getElementById('suggestions');

  async function refresh(){const rows=await idb.all();const names=[...new Set(rows.map(x=>x.name))];
    sugg.innerHTML='';names.forEach(n=>{const o=document.createElement('option');o.value=n;sugg.appendChild(o)});}
  async function render(term){const t=term.toLowerCase();const rows=await idb.all();
    const hit=rows.filter(r=>r.name.toLowerCase().includes(t));let s=0;rowsEl.innerHTML='';
    hit.forEach(r=>{s+=r.amount;const d=document.createElement('div');d.innerHTML=`<span>${r.name}</span><strong>${r.amount.toFixed(2)} лв</strong>`;rowsEl.appendChild(d)});
    sumEl.textContent=s.toFixed(2)+' лв';}

  btnSearch.onclick=async()=>{panel.classList.toggle('open');if(panel.classList.contains('open')){await refresh();render(q.value)}};
  q.addEventListener('input',()=>render(q.value));

  const btnSave=document.getElementById('btnSave');
  btnSave.onclick=async()=>{
    btnSave.disabled=true;
    toast('Запазвам...');
    const blob=await new Promise(r=>canvas.toBlob(b=>r(b),'image/png'));
    const reader=new FileReader();
    reader.onload=async()=>{
      try{
        const base64=reader.result;
        const r=await fetch(OCR_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({imageBase64:base64})});
        const d=await r.json();
        if(!d.ok)throw new Error(d.error);
        for(const e of d.entries){await idb.add({name:e.name,amount:e.amount,ts:Date.now()});}
        ctx.clearRect(0,0,canvas.width,canvas.height);
        toast('Готово, записани '+d.entries.length);
      }catch(err){toast('Грешка OCR');console.error(err);}
      btnSave.disabled=false;
    };
    reader.readAsDataURL(blob);
  };
});
</script>
</body>
</html>
