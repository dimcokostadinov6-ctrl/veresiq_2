<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Veresia</title>
<style>
  :root{--bg:#0e1116;--line:#1e3558;--ink:#f8fafc}
  html,body{margin:0;height:100%;background:#0b0f14;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;touch-action:none}
  .topbar{position:fixed;inset:0 0 auto 0;display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:rgba(11,15,20,.65);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:5}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.18);color:#e5e7eb;background:transparent;padding:.45rem .7rem;border-radius:.5rem;font-size:.95rem;cursor:pointer}
  .btn:hover{border-color:#ffffff44}
  .btn.primary{border-color:#60a5fa;background:#1e293b}
  .sep{flex:1}
  .stage{position:fixed;inset:44px 0 0 0;display:grid;grid-template-columns:1fr auto}
  .board-wrap{position:relative;overflow:hidden}
  canvas#board{
    width:100%;height:100%;display:block;touch-action:none;
    background:
      repeating-linear-gradient(to bottom,
        var(--bg) 0px, var(--bg) 26px,
        var(--line) 26px, var(--line) 27px);
  }
  .panel{width:min(380px,92vw);background:#0b1220;border-left:1px solid #1f2a44;padding:.75rem;display:none}
  .panel.open{display:block}
  .panel h3{margin:.2rem 0 .6rem;font-weight:600}
  .field{display:flex;gap:.5rem;align-items:center;margin:.25rem 0 .75rem}
  .field input{flex:1;padding:.45rem .6rem;border-radius:.45rem;background:#0c1426;color:#e5e7eb;border:1px solid #24314f}
  .pill{font-size:.8rem;padding:.2rem .45rem;border:1px solid #2b3b64;border-radius:999px}
  .list{font-size:.95rem;line-height:1.4;max-height:calc(100vh - 160px);overflow:auto}
  .list .row{display:flex;justify-content:space-between;gap:.6rem;padding:.35rem .2rem;border-bottom:1px dashed #1c2744}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111827;border:1px solid #374151;padding:.6rem .8rem;border-radius:.6rem;z-index:10;display:none}
  .toast.show{display:block}
  #hint{font-size:.85rem;opacity:.9}
</style>
</head>
<body>
  <div class="topbar">
    <strong>Veresia</strong>
    <button id="btnSave" class="btn primary">Запази</button>
    <div class="sep"></div>
    <button id="btnSearch" class="btn">Търсене</button>
    <span id="hint" title="Пише се само със стилус">✍️ Само писалка</span>
  </div>

  <div class="stage">
    <div class="board-wrap">
      <canvas id="board"></canvas>
    </div>
    <aside id="searchPanel" class="panel" aria-label="Търсене">
      <h3>Търсене</h3>
      <div class="field">
        <input id="q" type="search" placeholder="Име…" list="suggestions" autocomplete="off"/>
        <datalist id="suggestions"></datalist>
        <span id="sum" class="pill">0.00 лв</span>
      </div>
      <div id="rows" class="list" aria-live="polite"></div>
    </aside>
  </div>

  <div id="toast" class="toast"></div>

<script>
// ПОПЪЛНИ със своя URL от Cloud Run:
const OCR_URL = "https://ocr-980985905017.europe-west1.run.app";

/* ===== IndexedDB ===== */
const DB='veresia-db', STORE='names';
function withDB(mode,fn){return new Promise((res,rej)=>{const r=indexedDB.open(DB,1);
r.onupgradeneeded=()=>{const db=r.result;if(!db.objectStoreNames.contains(STORE))db.createObjectStore(STORE)};
r.onsuccess=()=>{const tx=r.result.transaction(STORE,mode);const s=tx.objectStore(STORE);
Promise.resolve(fn(s)).then(v=>{tx.oncomplete=()=>res(v);tx.onerror=()=>rej(tx.error)},rej)};
r.onerror=()=>rej(r.error)})}
const idb={
  get:k=>withDB('readonly',s=>new Promise((res,rej)=>{const r=s.get(k);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)})),
  set:(k,v)=>withDB('readwrite',s=>new Promise((res,rej)=>{const r=s.put(v,k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})),
  each:(cb)=>withDB('readonly',s=>new Promise((res,rej)=>{const c=s.openCursor();c.onsuccess=()=>{const k=c.result;if(k){cb(k.value,k.key);k.continue()}else res()};c.onerror=()=>rej(c.error)}))
};

/* ===== UI / Canvas ===== */
window.addEventListener('DOMContentLoaded',()=>{
  const canvas=document.getElementById('board');
  const ctx=canvas.getContext('2d',{willReadFrequently:true});
  let drawing=false,last=null;

  function resize(){const dpr=devicePixelRatio||1;const r=canvas.getBoundingClientRect();
    canvas.width=Math.floor(r.width*dpr);canvas.height=Math.floor(r.height*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);ctx.lineCap='round';ctx.lineJoin='round';
    ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--ink').trim()||'#fff';
  }
  addEventListener('resize',resize,{passive:true}); addEventListener('orientationchange',()=>setTimeout(resize,50),{passive:true}); resize();

  const isPen=e=>e.pointerType==='pen';
  const pxy=e=>{const r=canvas.getBoundingClientRect();return {x:e.clientX-r.left,y:e.clientY-r.top,p:e.pressure||0.5}};

  canvas.addEventListener('pointerdown',e=>{if(!isPen(e))return;e.preventDefault();drawing=true;last=pxy(e)});
  canvas.addEventListener('pointermove',e=>{if(!drawing||!isPen(e))return;const p=pxy(e);ctx.lineWidth=2+p.p*3.5;ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;});
  const stop=()=>{drawing=false;last=null};canvas.addEventListener('pointerup',stop);canvas.addEventListener('pointercancel',stop);canvas.addEventListener('pointerleave',stop);

  const toastEl=document.getElementById('toast'); const hint=document.getElementById('hint');
  function toast(m,ms=2200){toastEl.textContent=m;toastEl.classList.add('show');clearTimeout(toastEl._t);toastEl._t=setTimeout(()=>toastEl.classList.remove('show'),ms)}
  const step=t=>hint.textContent=t;

  async function addItems(items){
    for(const it of items){
      const key=it.name.trim().toLowerCase();
      const rec=(await idb.get(key))||{name:it.name,total:0,items:[]};
      rec.total=+(rec.total+it.amount).toFixed(2);
      rec.items.push({amount:it.amount,ts:Date.now()});
      await idb.set(key,rec);
    }
  }
  async function allRowsFlat(){
    const rows=[];await idb.each(rec=>{for(const it of rec.items)rows.push({name:rec.name,amount:it.amount,ts:it.ts})});
    rows.sort((a,b)=>b.ts-a.ts);return rows;
  }

  const panel=document.getElementById('searchPanel'),btnSearch=document.getElementById('btnSearch');
  const q=document.getElementById('q'),rowsEl=document.getElementById('rows'),sumEl=document.getElementById('sum'),sugg=document.getElementById('suggestions');

  btnSearch.onclick=async()=>{panel.classList.toggle('open');resize();if(panel.classList.contains('open')){await refreshSuggestions();renderSearch(q.value);q.focus()}};
  async function refreshSuggestions(){const seen=new Set();sugg.innerHTML='';await idb.each(rec=>{if(!seen.has(rec.name)){seen.add(rec.name);const o=document.createElement('option');o.value=rec.name;sugg.appendChild(o)}});}
  async function renderSearch(term){const t=(term||'').trim().toLowerCase();const rows=await allRowsFlat();const hit=rows.filter(r=>r.name.toLowerCase().includes(t));let s=0;rowsEl.innerHTML='';for(const r of hit){s+=r.amount;const d=document.createElement('div');d.className='row';d.innerHTML=`<span>${r.name}</span><strong>${r.amount.toFixed(2)} лв</strong>`;rowsEl.appendChild(d)}sumEl.textContent=`${s.toFixed(2)} лв`;}
  q.addEventListener('input',()=>renderSearch(q.value));

  async function callOCR(dataURL){
    const r=await fetch(OCR_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image:dataURL})});
    if(!r.ok) throw new Error(`HTTP ${r.status}`); return await r.json();
  }

  const btnSave=document.getElementById('btnSave');
  btnSave.onclick=async()=>{
    try{
      btnSave.disabled=true; step('Запис: снимка…');
      const blob=await new Promise(r=>canvas.toBlob(b=>r(b),'image/png'));
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`veresia-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
      document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url);a.remove()},0);

      const dataURL=canvas.toDataURL('image/png');
      ctx.clearRect(0,0,canvas.width,canvas.height); step('OCR…');

      callOCR(dataURL).then(async resp=>{
        if(resp?.ok && Array.isArray(resp.entries) && resp.entries.length){
          await addItems(resp.entries); toast(`Записани редове: ${resp.entries.length}`);
          if(panel.classList.contains('open')){await refreshSuggestions();renderSearch(q.value)}
        }else{ toast('Не открих „Име - сума“. Пример: Иван - 3,20'); }
        step('Готово');
      }).catch(err=>{ console.error('[OCR]',err); toast('OCR грешка (виж конзолата)'); step('Грешка'); });

    }catch(e){ console.error(e); toast('Грешка при „Запази“'); step('Грешка'); }
    finally{ btnSave.disabled=false; }
  };

  (async()=>{await refreshSuggestions()})();
});
</script>
</body>
</html>
