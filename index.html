<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Veresia</title>
<style>
  :root{--bg:#0e1116;--line:#1e3558;--ink:#f8fafc}
  html,body{margin:0;height:100%;background:#0b0f14;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;touch-action:none}
  .topbar{position:fixed;inset:0 0 auto 0;display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:rgba(11,15,20,.65);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:5}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.18);color:#e5e7eb;background:transparent;padding:.45rem .7rem;border-radius:.5rem;font-size:.95rem;cursor:pointer}
  .btn:hover{border-color:#ffffff44}
  .btn.primary{border-color:#60a5fa;background:#1e293b}
  .sep{flex:1}
  .stage{position:fixed;inset:44px 0 0 0;display:grid;grid-template-columns:1fr auto}
  .board-wrap{position:relative;overflow:hidden}
  canvas#board{
    width:100%;height:100%;display:block;touch-action:none;
    background:
      repeating-linear-gradient(to bottom,
        var(--bg) 0px, var(--bg) 26px,
        var(--line) 26px, var(--line) 27px);
  }
  .panel{width:min(360px,92vw);background:#0b1220;border-left:1px solid #1f2a44;padding:.75rem;display:none}
  .panel.open{display:block}
  .panel h3{margin:.2rem 0 .6rem;font-weight:600}
  .field{display:flex;gap:.5rem;align-items:center;margin:.25rem 0 .75rem}
  .field input{flex:1;padding:.45rem .6rem;border-radius:.45rem;background:#0c1426;color:#e5e7eb;border:1px solid #24314f}
  .pill{font-size:.8rem;padding:.2rem .45rem;border:1px solid #2b3b64;border-radius:999px}
  .list{font-size:.95rem;line-height:1.4}
  .list div{display:flex;justify-content:space-between;padding:.35rem .2rem;border-bottom:1px dashed #1c2744}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111827;border:1px solid #374151;padding:.6rem .8rem;border-radius:.6rem;z-index:10;display:none}
  .toast.show{display:block}
  #hint{font-size:.85rem;opacity:.9}

  .pen-badge{
    position:fixed; right:10px; bottom:10px; z-index:6;
    background:#0f172a;border:1px solid #263042;border-radius:999px;
    padding:.35rem .55rem; font-size:1rem; user-select:none; pointer-events:none; opacity:.9;
    display:flex; align-items:center; gap:.4rem;
  }
  .pen-badge span{font-size:1.05rem}
</style>
</head>
<body>
  <div class="topbar">
    <strong>Veresia</strong>
    <button id="btnSave" class="btn primary">–ó–∞–ø–∞–∑–∏</button>
    <div class="sep"></div>
    <button id="btnSearch" class="btn">–¢—ä—Ä—Å–µ–Ω–µ</button>
    <span id="hint" title="–ü–∏—à–µ —Å–µ —Å–∞–º–æ —Å—ä—Å —Å—Ç–∏–ª—É—Å">‚úçÔ∏è –°–∞–º–æ –ø–∏—Å–∞–ª–∫–∞</span>
  </div>

  <div class="stage">
    <div class="board-wrap">
      <canvas id="board"></canvas>
    </div>
    <aside id="searchPanel" class="panel" aria-label="–¢—ä—Ä—Å–µ–Ω–µ">
      <h3>–¢—ä—Ä—Å–µ–Ω–µ</h3>
      <div class="field">
        <input id="q" type="search" placeholder="–ò–º–µ‚Ä¶" list="suggestions" autocomplete="off"/>
        <datalist id="suggestions"></datalist>
        <span id="sum" class="pill">0.00 –ª–≤</span>
      </div>
      <div id="rows" class="list" aria-live="polite"></div>
    </aside>
  </div>

  <div id="toast" class="toast"></div>
  <div class="pen-badge" title="–ü–∏—à–µ —Å–µ —Å–∞–º–æ —Å—ä—Å —Å—Ç–∏–ª—É—Å"><span>üñêÔ∏èüñäÔ∏è</span><small>–°—Ç–∏–ª—É—Å</small></div>

  <!-- Tesseract –∑–∞ OFFLINE —Ä–µ–∑–µ—Ä–≤ -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
/* ====== –ö–û–ù–§–ò–ì ====== */
const GOOGLE_VISION_API_KEY = "YOUR_GOOGLE_VISION_API_KEY_HERE"; // ‚Üê –ø–æ—Å—Ç–∞–≤–∏ —Ç–≤–æ—è –∫–ª—é—á
const USE_FALLBACK_TESSERACT_IF_ERROR = true;

/* ===== IndexedDB (–ª–æ–∫–∞–ª–Ω–∞ –±–∞–∑–∞) ===== */
const DB_NAME='veresia-db', STORE='names', DB_VER=1;
function withDB(mode,fn){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VER);
r.onupgradeneeded=()=>{const db=r.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);};
r.onerror=()=>rej(r.error);
r.onsuccess=()=>{const tx=r.result.transaction(STORE,mode);const s=tx.objectStore(STORE);
Promise.resolve(fn(s)).then(v=>{tx.oncomplete=()=>res(v);tx.onerror=()=>rej(tx.error);},rej);} }) }
const idb={get:k=>withDB('readonly',s=>new Promise((res,rej)=>{const r=s.get(k);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)})),
           set:(k,v)=>withDB('readwrite',s=>new Promise((res,rej)=>{const r=s.put(v,k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})),
           iterate:(cb)=>withDB('readonly',s=>new Promise((res,rej)=>{const r=s.openCursor();r.onsuccess=()=>{const c=r.result;if(c){cb(c.value,c.key);c.continue()}else res()};r.onerror=()=>rej(r.error)}))};

/* ===== –†–ï–ß–ù–ò–ö + FUZZY (–ø–æ –∏–∑–±–æ—Ä –ø–æ–ø—ä–ª–≤–∞–π —Å —Ç–≤–æ–∏ –∏–º–µ–Ω–∞) ===== */
const DICT = new Set([
  '–ò–≤–∞–Ω','–ú–∞—Ä–∏—è','–ü–µ—Ç—ä—Ä','–ì–µ–æ—Ä–≥–∏','–ù–∏–∫–æ–ª–∞','–ò–ª–∏—è','–°—Ç–µ—Ñ–∞–Ω','–î–∏–º–∏—Ç—ä—Ä','–ö–∞–ª–æ—è–Ω','–°—Ç–æ—è–Ω',
  '–ú–∏–ª–∞','–ú–∏–º–∏','–¢–æ–Ω–∏','–í–∏–∫—Ç–æ—Ä','–†–æ—Å–∏','–°–∞—à–æ','–ö–∏—Ä–æ'
]);
function lev(a,b){ // –±—ä—Ä–∑ Levenshtein
  a=a.toLowerCase(); b=b.toLowerCase();
  const m=a.length,n=b.length; const dp=Array(n+1).fill(0).map((_,j)=>j);
  for(let i=1;i<=m;i++){ let prev=dp[0]++; for(let j=1;j<=n;j++){ const t=dp[j]; dp[j]=a[i-1]===b[j-1]?prev:1+Math.min(prev,dp[j-1],dp[j]); prev=t; } }
  return dp[n];
}
function fuzzyName(name){
  let best=name, bestD=2; // –ø–æ–∑–≤–æ–ª—è–≤–∞–º–µ 1‚Äì2 –≥—Ä–µ—à–∫–∏
  for(const w of DICT){ const d=lev(name,w); if(d<bestD){bestD=d; best=w;} }
  return best;
}

/* ===== UI / Canvas ===== */
window.addEventListener('DOMContentLoaded',()=>{
  const canvas=document.getElementById('board');
  const ctx=canvas.getContext('2d',{willReadFrequently:true});
  let drawing=false,last=null;

  function resize(){const dpr=window.devicePixelRatio||1;const r=canvas.getBoundingClientRect();
    canvas.width=Math.floor(r.width*dpr);canvas.height=Math.floor(r.height*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);ctx.lineJoin='round';ctx.lineCap='round';ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--ink').trim()||'#fff';}
  window.addEventListener('resize',resize,{passive:true});
  window.addEventListener('orientationchange',()=>setTimeout(resize,50),{passive:true});
  resize();

  const isPen=e=>e.pointerType==='pen';
  const pos=e=>{const r=canvas.getBoundingClientRect();return {x:e.clientX-r.left,y:e.clientY-r.top,p:e.pressure||0.5}};

  canvas.addEventListener('pointerdown',e=>{if(!isPen(e))return;e.preventDefault();drawing=true;last=pos(e)});
  canvas.addEventListener('pointermove',e=>{if(!drawing||!isPen(e))return;const p=pos(e);ctx.lineWidth=2+p.p*3.5;ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;});
  const stop=()=>{drawing=false;last=null};canvas.addEventListener('pointerup',stop);canvas.addEventListener('pointercancel',stop);canvas.addEventListener('pointerleave',stop);

  const toastEl=document.getElementById('toast'); const hint=document.getElementById('hint');
  function toast(m,ms=2200){toastEl.textContent=m;toastEl.classList.add('show');clearTimeout(toastEl._t);toastEl._t=setTimeout(()=>toastEl.classList.remove('show'),ms)}
  const step=t=>{hint.textContent=t};

  async function saveEntry(name,amount){
    name = name.trim();
    name = DICT.has(name) ? name : fuzzyName(name); // –∫–æ—Ä–µ–∫—Ü–∏—è –ø–æ —Ä–µ—á–Ω–∏–∫
    const key=name.toLowerCase();
    const prev=await idb.get(key)||{name,total:0,items:[]};
    prev.total=+(prev.total+amount).toFixed(2);
    prev.items.push({amount,ts:Date.now()});
    await idb.set(key,prev);
  }
  async function allEntries(){const rows=[];await idb.iterate(v=>rows.push(v));rows.sort((a,b)=>a.name.localeCompare(b.name,'bg'));return rows}

  const panel=document.getElementById('searchPanel');const btnSearch=document.getElementById('btnSearch');
  const q=document.getElementById('q');const rowsEl=document.getElementById('rows');const sumEl=document.getElementById('sum');const sugg=document.getElementById('suggestions');

  btnSearch.onclick=async()=>{panel.classList.toggle('open');resize();if(panel.classList.contains('open')){await refreshSuggestions();renderSearch(q.value);q.focus()}};
  async function refreshSuggestions(){const rows=await allEntries();sugg.innerHTML='';rows.forEach(r=>{const o=document.createElement('option');o.value=r.name;sugg.appendChild(o)})}
  async function renderSearch(term){const t=(term||'').trim().toLowerCase();const rows=await allEntries();const hit=rows.filter(r=>r.name.toLowerCase().includes(t));let s=0;rowsEl.innerHTML='';hit.forEach(r=>{s+=r.total;const d=document.createElement('div');d.innerHTML=`<span>${r.name}</span><strong>${r.total.toFixed(2)} –ª–≤</strong>`;rowsEl.appendChild(d)});sumEl.textContent=`${s.toFixed(2)} –ª–≤`;}
  q.addEventListener('input',()=>renderSearch(q.value));

  /* ===== –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–º–∞—Ö–∞–Ω–µ –ª–∏–Ω–∏–∏ + –±–∏–Ω–∞—Ä–∏–∑–∞—Ü–∏—è) ===== */
  function prepImageForOCR(src){
    const dpr=window.devicePixelRatio||1, scale=3;
    const w=Math.floor(src.width/dpr*scale), h=Math.floor(src.height/dpr*scale);
    const out=document.createElement('canvas'); out.width=w; out.height=h;
    const o=out.getContext('2d',{willReadFrequently:true});
    o.drawImage(src,0,0,w,h);
    let img=o.getImageData(0,0,w,h), d=img.data;
    for(let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2], bright=r+g+b;
      const isInk = bright>680; const isBlue= b>60 && b>r+20 && b>g+10;
      let v; if(isInk) v=0; else if(isBlue) v=255; else v=255;
      d[i]=d[i+1]=d[i+2]=v; d[i+3]=255;
    }
    o.putImageData(img,0,0);
    const g=o.getImageData(0,0,w,h); const G=g.data;
    for(let y=1;y<h-1;y++){for(let x=1;x<w-1;x++){
      let s=0,c=0; for(let yy=-1;yy<=1;yy++)for(let xx=-1;xx<=1;xx++){const i=((y+yy)*w+(x+xx))*4; s+=G[i]; c++;}
      const i=(y*w+x)*4; const mean=s/c; const v=G[i]<mean-15?0:255; G[i]=G[i+1]=G[i+2]=v; G[i+3]=255;
    }}
    o.putImageData(g,0,0);
    return out;
  }

  /* ====== Google Vision OCR (–±–µ–∫–≥—Ä–∞—É–Ω–¥ –æ–ø–∞—à–∫–∞) ====== */
  const ocrQ = {
    queue:[], busy:false,
    push(blob){ this.queue.push(blob); this.drain(); },
    async drain(){
      if(this.busy || !this.queue.length) return;
      this.busy=true;
      const blob=this.queue.shift();
      try{
        step('OCR: Google‚Ä¶');
        const text = await googleVisionOCR(blob);
        const entries = parseLines(text);
        if(entries.length){
          for(const e of entries){ await saveEntry(e.name,e.amount); }
          toast(`–î–æ–±–∞–≤–µ–Ω–∏: ${entries.length}`);
          if(panel.classList.contains('open')){ await refreshSuggestions(); renderSearch(q.value); }
        }else{
          toast('–ù–µ –æ—Ç–∫—Ä–∏—Ö ‚Äû–ò–º–µ - —Å—É–º–∞‚Äú.');
        }
      }catch(err){
        console.warn('Vision error -> fallback:', err);
        if(USE_FALLBACK_TESSERACT_IF_ERROR){
          try{
            const text = await tesseractFallback(blob);
            const entries = parseLines(text);
            if(entries.length){
              for(const e of entries){ await saveEntry(e.name,e.amount); }
              toast(`(–û—Ñ–ª–∞–π–Ω) –î–æ–±–∞–≤–µ–Ω–∏: ${entries.length}`);
              if(panel.classList.contains('open')){ await refreshSuggestions(); renderSearch(q.value); }
            }else toast('–ù–µ –æ—Ç–∫—Ä–∏—Ö ‚Äû–ò–º–µ - —Å—É–º–∞‚Äú (–æ—Ñ–ª–∞–π–Ω).');
          }catch(e2){ console.warn(e2); toast('OCR –≥—Ä–µ—à–∫–∞.'); }
        }else{
          toast('OCR –≥—Ä–µ—à–∫–∞.');
        }
      }finally{
        this.busy=false; this.drain();
      }
    }
  };

  async function blobToBase64(blob){
    const b = await blob.arrayBuffer();
    const bin = String.fromCharCode(...new Uint8Array(b));
    return 'data:application/octet-stream;base64,' + btoa(bin);
  }

  async function googleVisionOCR(blob){
    if(!GOOGLE_VISION_API_KEY) throw new Error('Missing API key');
    // –í–∑–µ–º–∞–º–µ –ø—Ä–µ—Ä–∞–±–æ—Ç–µ–Ω–æ (–ø–æ—á–∏—Å—Ç–µ–Ω–æ) –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞ –ø–æ-–ª–µ—Å–µ–Ω OCR
    const bmp = await createImageBitmap(blob);
    const cleaned = prepImageForOCR(bmp);
    const cleanedBlob = await new Promise(r=>cleaned.toBlob(r,'image/png',0.92));
    const base64 = await blobToBase64(cleanedBlob);

    const body = {
      requests: [{
        image: { content: base64.split(',')[1] },
        features: [{ type: "DOCUMENT_TEXT_DETECTION" }],
        imageContext: { languageHints: ["bul","en"] }
      }]
    };

    const resp = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${encodeURIComponent(GOOGLE_VISION_API_KEY)}`, {
      method: "POST",
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const json = await resp.json();
    if(json.error) throw new Error(json.error.message || 'Vision API error');
    const ann = json.responses?.[0]?.fullTextAnnotation?.text || json.responses?.[0]?.textAnnotations?.[0]?.description || '';
    return ann;
  }

  // Offline —Ä–µ–∑–µ—Ä–≤ ‚Äì Tesseract.js
  async function tesseractFallback(blob){
    const worker = await Tesseract.createWorker('bul+eng');
    await worker.setParameters({
      tessedit_pageseg_mode:'6',
      preserve_interword_spaces:'1',
      tessedit_char_whitelist:"–∞–±–≤–≥–¥–µ–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—å—é—è–ê–ë–í–ì–î–ï–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–¨–Æ–ØabcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-‚Äì‚Äî., '=:"
    });
    const {data:{text}} = await worker.recognize(blob);
    await worker.terminate();
    return text || '';
  }

  // –ü–∞—Ä—Å–∏–Ω–≥: ‚Äû–ò–º–µ - —Å—É–º–∞‚Äú
  function parseLines(text){
    const out=[];
    const norm=(s)=>s.normalize('NFC').replace(/[‚Äì‚Äî‚àí]/g,'-');
    const lines = norm(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const rx=/([A-Za-z–ê-–Ø–∞-—è'‚Äô.\- ]{2,50})\s*[-=:]\s*([0-9]{1,4}(?:[.,][0-9]{1,2})?)/u;
    for(const ln of lines){
      const m=ln.match(rx);
      if(m){
        let name=m[1].replace(/[^\p{L}\s'‚Äô.-]/gu,' ').replace(/\s+/g,' ').trim();
        let amt = parseFloat(String(m[2]).replace(',', '.'));
        if(name && isFinite(amt)) out.push({name,amount:+amt.toFixed(2)});
      }
    }
    return out;
  }

  /* ===== –ó–∞–ø–∞–∑–∏: —Å–≤–∞–ª—è PNG ‚Üí —á–∏—Å—Ç–∏ –ø–ª–∞—Ç–Ω–æ—Ç–æ ‚Üí OCR –≤ –æ–ø–∞—à–∫–∞ (–±–µ–∫–≥—Ä–∞—É–Ω–¥) ===== */
  const btnSave=document.getElementById('btnSave');
  btnSave.onclick=async()=>{
    try{
      btnSave.disabled=true; step('–ó–∞–ø–∏—Å: —Å–Ω–∏–º–∫–∞‚Ä¶');
      const blob=await new Promise(r=>canvas.toBlob(b=>r(b),'image/png'));
      // —Å–≤–∞–ª—è–Ω–µ –Ω–∞ PNG
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download=`veresia-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
      document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove()},0);

      // –≤–µ–¥–Ω–∞–≥–∞ —á–∏—Å—Ç–∏–º ‚Äì –º–æ–∂–µ—à –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏—à –¥–∞ –ø–∏—à–µ—à
      ctx.clearRect(0,0,canvas.width,canvas.height);
      step('OCR –≤ –±–µ–∫–≥—Ä–∞—É–Ω–¥‚Ä¶');

      // –ø—É—Å–∫–∞–º–µ OCR (Google ‚Üí fallback)
      ocrQ.push(blob);
    }catch(err){console.error(err);toast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ ‚Äû–ó–∞–ø–∞–∑–∏‚Äú');step('–ì—Ä–µ—à–∫–∞')}
    finally{btnSave.disabled=false}
  };

  // –¢—ä—Ä—Å–µ–Ω–µ
  (async()=>{
    await refreshSuggestions();
  })();

});
</script>
</body>
</html>
