<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Veresia</title>
<style>
  :root{--bg:#0e1116;--line:#1e3558;--ink:#f8fafc}
  html,body{margin:0;height:100%;background:#0b0f14;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;touch-action:none}
  .topbar{position:fixed;inset:0 0 auto 0;display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:rgba(11,15,20,.65);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:5}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.18);color:#e5e7eb;background:transparent;padding:.45rem .7rem;border-radius:.5rem;font-size:.95rem;cursor:pointer}
  .btn:hover{border-color:#ffffff44}
  .btn.primary{border-color:#60a5fa;background:#1e293b}
  .sep{flex:1}
  .stage{position:fixed;inset:44px 0 0 0;display:grid;grid-template-columns:1fr auto}
  .board-wrap{position:relative;overflow:hidden}
  canvas#board{
    width:100%;height:100%;display:block;touch-action:none;
    background:
      repeating-linear-gradient(to bottom,
        var(--bg) 0px, var(--bg) 26px,
        var(--line) 26px, var(--line) 27px);
  }
  .panel{width:min(380px,92vw);background:#0b1220;border-left:1px solid #1f2a44;padding:.75rem;display:none}
  .panel.open{display:block}
  .panel h3{margin:.2rem 0 .6rem;font-weight:600}
  .tabs{display:flex;gap:.4rem;margin:.25rem 0 .75rem}
  .tab{padding:.25rem .6rem;border:1px solid #2b3b64;border-radius:.45rem;cursor:pointer}
  .tab.active{background:#12203a}
  .field{display:flex;gap:.5rem;align-items:center;margin:.25rem 0 .75rem}
  .field input{flex:1;padding:.45rem .6rem;border-radius:.45rem;background:#0c1426;color:#e5e7eb;border:1px solid #24314f}
  .pill{font-size:.8rem;padding:.2rem .45rem;border:1px solid #2b3b64;border-radius:999px}
  .list{font-size:.95rem;line-height:1.4}
  .list div{display:grid;grid-template-columns:1fr auto auto;gap:.5rem;align-items:center;padding:.35rem .2rem;border-bottom:1px dashed #1c2744}
  .review-card{border:1px solid #263455;border-radius:.6rem;padding:.6rem;margin:.5rem 0;display:grid;gap:.4rem;background:#0c1426}
  .review-actions{display:flex;gap:.5rem;justify-content:flex-end}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111827;border:1px solid #374151;padding:.6rem .8rem;border-radius:.6rem;z-index:10;display:none}
  .toast.show{display:block}
  #hint{font-size:.85rem;opacity:.9}
  .pen-indicator{position:fixed;right:10px;top:50px;width:34px;height:34px;border-radius:50%;background:#0e1628;border:1px solid #203255;display:grid;place-items:center;z-index:6}
  .pen-indicator:after{content:"✍️";font-size:18px}
  small.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;opacity:.8}
</style>
</head>
<body>
  <div class="topbar">
    <strong>Veresia</strong>
    <button id="btnSave" class="btn primary">Запази</button>
    <div class="sep"></div>
    <button id="btnSearch" class="btn">Търсене</button>
    <span id="hint" title="Пише се само със стилус">✍️ Само писалка</span>
  </div>
  <div class="pen-indicator" title="Само със стилус"></div>

  <div class="stage">
    <div class="board-wrap"><canvas id="board"></canvas></div>

    <aside id="panel" class="panel" aria-label="Търсене">
      <div class="tabs">
        <button id="tabSearch" class="tab active">Търсене</button>
        <button id="tabReview" class="tab">За преглед</button>
      </div>

      <section id="searchSec">
        <h3>Търсене</h3>
        <div class="field">
          <input id="q" type="search" placeholder="Име…" list="suggestions" autocomplete="off"/>
          <datalist id="suggestions"></datalist>
          <span id="sum" class="pill">0.00 лв</span>
        </div>
        <div id="rows" class="list" aria-live="polite"></div>
      </section>

      <section id="reviewSec" hidden>
        <h3>Редове за потвърждение</h3>
        <div id="reviewList"></div>
      </section>
    </aside>
  </div>

  <div id="toast" class="toast"></div>

<script>
/*** === КОНФИГ === ***/
let OCR_URL = "https://ocr-980985905017.europe-west1.run.app";
if (!/\/ocr\/?$/.test(OCR_URL)) OCR_URL = OCR_URL.replace(/\/?$/, "/ocr");

/*** === IndexedDB === ***/
const DB_NAME='veresia-db', STORE='names', REVIEW='review', DB_VER=3;
function withDB(mode,store,fn){return new Promise((res,rej)=>{
  const r=indexedDB.open(DB_NAME,DB_VER);
  r.onupgradeneeded=()=>{const db=r.result;
    if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
    if(!db.objectStoreNames.contains(REVIEW)) db.createObjectStore(REVIEW);
  };
  r.onerror=()=>rej(r.error);
  r.onsuccess=()=>{const tx=r.result.transaction(store,mode);const s=tx.objectStore(store);
    Promise.resolve(fn(s)).then(v=>{tx.oncomplete=()=>res(v);tx.onerror=()=>rej(tx.error);},rej);}
})}
const idb={
  get:(store,k)=>withDB('readonly',store,s=>new Promise((res,rej)=>{const r=s.get(k);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)})),
  set:(store,k,v)=>withDB('readwrite',store,s=>new Promise((res,rej)=>{const r=s.put(v,k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})),
  del:(store,k)=>withDB('readwrite',store,s=>new Promise((res,rej)=>{const r=s.delete(k);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})),
  iterate:(store,cb)=>withDB('readonly',store,s=>new Promise((res,rej)=>{const r=s.openCursor();r.onsuccess=()=>{const c=r.result;if(c){cb(c.value,c.key);c.continue()}else res()};r.onerror=()=>rej(r.error)}))
};

/*** === Помощни === ***/
function toast(msg,ms=2400){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');clearTimeout(el._t);el._t=setTimeout(()=>el.classList.remove('show'),ms)}
const step=t=>document.getElementById('hint').textContent=t;

// Само българска кирилица + 1:1 мап за визуални двойници (НЕ е автокоректор на думи)
function normalizeBulgarian(s){
  if(!s) return '';
  const map={A:'А',a:'а',B:'В',E:'Е',e:'е',K:'К',k:'к',M:'М',m:'м',H:'Н',h:'н',O:'О',o:'о',P:'Р',p:'р',C:'С',c:'с',T:'Т',t:'т',X:'Х',x:'х',Y:'У',y:'у'};
  s=s.replace(/[ABEKMHOPCTXYabekmhopctxy]/g, ch=>map[ch]||ch);
  s=s.replace(/[^абвгдежзийклмнопрстуфхцчшщъьюяѝАБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЮЯЍ\s.'’-]/g,'');
  return s.replace(/\s+/g,' ').trim();
}

/*** === Canvas === ***/
window.addEventListener('DOMContentLoaded',()=>{
  const canvas=document.getElementById('board');
  const ctx=canvas.getContext('2d',{willReadFrequently:true});
  let drawing=false,last=null;

  function resize(){const dpr=window.devicePixelRatio||1;const r=canvas.getBoundingClientRect();
    canvas.width=Math.floor(r.width*dpr);canvas.height=Math.floor(r.height*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);ctx.lineJoin='round';ctx.lineCap='round';
    ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--ink').trim()||'#fff';}
  window.addEventListener('resize',resize,{passive:true});window.addEventListener('orientationchange',()=>setTimeout(resize,50),{passive:true});resize();

  const isPen=e=>e.pointerType==='pen';
  const pos=e=>{const r=canvas.getBoundingClientRect();return {x:e.clientX-r.left,y:e.clientY-r.top,p:e.pressure||0.5}};

  canvas.addEventListener('pointerdown',e=>{if(!isPen(e))return;e.preventDefault();drawing=true;last=pos(e)});
  canvas.addEventListener('pointermove',e=>{if(!drawing||!isPen(e))return;const p=pos(e);ctx.lineWidth=2+p.p*3.5;ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;});
  const stop=()=>{drawing=false;last=null};canvas.addEventListener('pointerup',stop);canvas.addEventListener('pointercancel',stop);canvas.addEventListener('pointerleave',stop);

  /*** === Търсене === ***/
  const panel=document.getElementById('panel'), btnSearch=document.getElementById('btnSearch');
  const tabSearch=document.getElementById('tabSearch'), tabReview=document.getElementById('tabReview');
  const searchSec=document.getElementById('searchSec'), reviewSec=document.getElementById('reviewSec');
  const q=document.getElementById('q');const rowsEl=document.getElementById('rows');const sumEl=document.getElementById('sum');const sugg=document.getElementById('suggestions');
  const reviewList=document.getElementById('reviewList');

  function switchTab(which){
    if(which==='search'){tabSearch.classList.add('active');tabReview.classList.remove('active');searchSec.hidden=false;reviewSec.hidden=true;}
    else{tabSearch.classList.remove('active');tabReview.classList.add('active');searchSec.hidden=true;reviewSec.hidden=false;renderReview();}
  }
  tabSearch.onclick=()=>switchTab('search'); tabReview.onclick=()=>switchTab('review');

  btnSearch.onclick=async()=>{panel.classList.toggle('open');resize();if(panel.classList.contains('open')){await refreshSuggestions();renderSearch(q.value);q.focus()}};
  async function refreshSuggestions(){const rows=[];await idb.iterate(STORE,v=>rows.push(v));rows.sort((a,b)=>a.name.localeCompare(b.name,'bg'));sugg.innerHTML='';rows.forEach(r=>{const o=document.createElement('option');o.value=r.name;sugg.appendChild(o)})}

  async function renderSearch(term){
    const t=(term||'').trim().toLowerCase();
    const rows=[]; await idb.iterate(STORE,v=>rows.push(v));
    const items=[];
    rows.forEach(r=>{ if(!t || r.name.toLowerCase().includes(t)){ r.items.forEach(it=>items.push({name:r.name,amount:it.amount,ts:it.ts})) } });
    items.sort((a,b)=>a.name.localeCompare(b.name,'bg') || a.ts-b.ts);
    let total=0; rowsEl.innerHTML='';
    items.forEach(x=>{ total+=x.amount;
      const d=document.createElement('div');
      const when=new Date(x.ts).toLocaleString('bg-BG',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'});
      d.innerHTML=`<span>${x.name}</span><strong>${x.amount.toFixed(2)} лв</strong><small class="mono">${when}</small>`;
      rowsEl.appendChild(d);
    });
    sumEl.textContent=`${total.toFixed(2)} лв`;
  }
  q.addEventListener('input',()=>renderSearch(q.value));

  /*** === За преглед === ***/
  async function addReviewItem({id,text,crop}){
    // id: уникален; text: OCR ред (суров); crop: dataURL за миниатюра
    await idb.set(REVIEW,id,{id,text,crop,ts:Date.now()});
  }
  async function renderReview(){
    reviewList.innerHTML='';
    const arr=[]; await idb.iterate(REVIEW,(v)=>arr.push(v));
    arr.sort((a,b)=>a.ts-b.ts);
    arr.forEach(item=>{
      const card=document.createElement('div'); card.className='review-card';
      const ocrRaw = (item.text||'').replace(/\s+/g,' ').trim();
      const shown = normalizeBulgarian(ocrRaw);
      card.innerHTML = `
        <div style="display:flex;gap:.6rem;align-items:flex-start">
          <img alt="снимка" src="${item.crop||''}" style="width:90px;height:60px;object-fit:cover;border:1px solid #24314f;border-radius:.4rem;background:#0b1120"/>
          <div style="flex:1">
            <label>Име (кирилица)</label>
            <input class="name" value="${shown}" placeholder="Име" style="width:100%;padding:.4rem;border:1px solid #24314f;border-radius:.4rem;background:#0c1426;color:#e5e7eb"/>
            <div style="display:flex;gap:.5rem;margin-top:.4rem">
              <div>
                <label>Сума</label>
                <input class="amt" value="" inputmode="decimal" placeholder="0,00" style="width:120px;padding:.4rem;border:1px solid #24314f;border-radius:.4rem;background:#0c1426;color:#e5e7eb"/>
              </div>
            </div>
            <div class="review-actions">
              <button class="btn primary confirm">Потвърди</button>
              <button class="btn delete">Изтрий</button>
            </div>
            <small class="mono">OCR: ${ocrRaw||'(без текст)'}</small>
          </div>
        </div>`;
      card.querySelector('.confirm').onclick=async()=>{
        const name=normalizeBulgarian(card.querySelector('.name').value||'');
        const amtStr=(card.querySelector('.amt').value||'').replace(/\s+/g,'').replace(',','.');
        const amount=parseFloat(amtStr);
        if(!name || !Number.isFinite(amount)){ toast('Попълни коректно име и сума'); return; }
        await saveEntry(name,amount); await idb.del(REVIEW,item.id);
        toast('Добавено'); renderReview(); await refreshSuggestions(); renderSearch(q.value);
      };
      card.querySelector('.delete').onclick=async()=>{ await idb.del(REVIEW,item.id); renderReview(); };
      reviewList.appendChild(card);
    });
  }

  /*** === Записване в база === ***/
  async function saveEntry(name,amount){
    const key=name.trim().toLowerCase();
    const prev=await idb.get(STORE,key)||{name,total:0,items:[]};
    prev.total=+(prev.total+amount).toFixed(2);
    prev.items.push({amount,ts:Date.now()});
    await idb.set(STORE,key,prev);
  }

  /*** === Подготовка на изображение за OCR === ***/
  function prepForOCR(src){
    const dpr=window.devicePixelRatio||1, scale=3;
    const w=Math.floor(src.width/dpr*scale), h=Math.floor(src.height/dpr*scale);
    const out=document.createElement('canvas'); out.width=w; out.height=h;
    const o=out.getContext('2d',{willReadFrequently:true});
    o.drawImage(src,0,0,w,h);
    // Бинаризация без „автокорекция“
    let img=o.getImageData(0,0,w,h), d=img.data;
    for(let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      const bright=r+g+b;
      const isInk = bright>680; // белият „маркер“ от теб
      const isBlue = b>60 && b>r+20 && b>g+10;
      const v = isInk ? 0 : 255;
      d[i]=d[i+1]=d[i+2]=(isBlue?255:v); d[i+3]=255;
    }
    o.putImageData(img,0,0);
    return out;
  }

  /*** === OCR към бекенда (без автокорекции) === ***/
  async function sendToOCR(dataURL){
    try{
      step('OCR: изпращане…');
      const base64=dataURL.split(',')[1];
      const r=await fetch(OCR_URL,{method:'POST',mode:'cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({ imageBase64: base64 })});
      const j=await r.json();
      if(!r.ok || !j.ok) throw new Error(j?.error||('HTTP '+r.status));

      // 1) Успешните (масив от {name,amount})
      if(Array.isArray(j.entries)){
        for(const e of j.entries){
          const name=normalizeBulgarian(e.name);
          const amt=parseFloat(String(e.amount).replace(',','.'));
          if(name && Number.isFinite(amt)) await saveEntry(name,amt);
          else await addReviewItem({id:`fail-${Date.now()}-${Math.random()}`, text:`${e.name||''} - ${e.amount||''}`, crop:''});
        }
      }

      // 2) За преглед (ако бекендът върне rawLines за по-лесно довършване)
      if(Array.isArray(j.review)){
        for(const it of j.review){
          await addReviewItem({id:it.id||(`r-${Date.now()}-${Math.random()}`), text:it.text||'', crop:it.crop||''});
        }
      }

      toast(`Записани редове: ${(j.entries&&j.entries.length)||0}`);
      step('Готово');
      if(panel.classList.contains('open')){ await refreshSuggestions(); renderSearch(q.value); }
    }catch(err){ console.error('[OCR] →', err); toast('OCR грешка (виж конзолата)'); step('Грешка'); }
  }

  /*** === Запази === ***/
  const btnSave=document.getElementById('btnSave');
  btnSave.onclick=async()=>{
    try{
      step('Запис: снимка…');
      const blob=await new Promise(r=>canvas.toBlob(b=>r(b),'image/png'));
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download=`veresia-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
      document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove()},0);

      // OCR във фона
      const pre=prepForOCR(canvas);
      const dataURL=pre.toDataURL('image/png');

      // Нов лист – веднага можеш да пишеш
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // Пращаме към бекенда
      void sendToOCR(dataURL);
    }catch(err){ console.error(err); toast('Грешка при „Запази“'); step('Грешка'); }
  };

  (async()=>{await refreshSuggestions()})();
});
</script>
</body>
</html>
