<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Veresia</title>
<style>
  :root{--bg:#0e1116;--line:#1e3558;--ink:#f8fafc}
  html,body{margin:0;height:100%;background:#0b0f14;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;touch-action:none}
  .topbar{position:fixed;inset:0 0 auto 0;display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:rgba(11,15,20,.65);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:5}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.18);color:#e5e7eb;background:transparent;padding:.45rem .7rem;border-radius:.5rem;font-size:.95rem;cursor:pointer}
  .btn:hover{border-color:#ffffff44}
  .btn.primary{border-color:#60a5fa;background:#1e293b}
  .sep{flex:1}
  .stage{position:fixed;inset:44px 0 0 0;display:grid;grid-template-columns:1fr auto}
  .board-wrap{position:relative;overflow:hidden}
  canvas#board{
    width:100%;height:100%;display:block;touch-action:none;
    background:
      repeating-linear-gradient(to bottom,
        var(--bg) 0px, var(--bg) 26px,
        var(--line) 26px, var(--line) 27px);
  }
  .panel{width:min(360px,92vw);background:#0b1220;border-left:1px solid #1f2a44;padding:.75rem;display:none}
  .panel.open{display:block}
  .panel h3{margin:.2rem 0 .6rem;font-weight:600}
  .field{display:flex;gap:.5rem;align-items:center;margin:.25rem 0 .75rem}
  .field input{flex:1;padding:.45rem .6rem;border-radius:.45rem;background:#0c1426;color:#e5e7eb;border:1px solid #24314f}
  .pill{font-size:.8rem;padding:.2rem .45rem;border:1px solid #2b3b64;border-radius:999px}
  .list{font-size:.95rem;line-height:1.4}
  .row{display:flex;justify-content:space-between;gap:.6rem;padding:.35rem .2rem;border-bottom:1px dashed #1c2744}
  .row small{opacity:.6}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111827;border:1px solid #374151;padding:.6rem .8rem;border-radius:.6rem;z-index:10;display:none}
  .toast.show{display:block}
  #hint{font-size:.85rem;opacity:.9}
  .pen-badge{position:fixed;right:.6rem;top:.6rem;z-index:6;width:36px;height:36px;border-radius:50%;display:grid;place-items:center;background:#0c1426;border:1px solid #223152}
</style>
</head>
<body>
  <div class="topbar">
    <strong>Veresia</strong>
    <button id="btnSave" class="btn primary">–ó–∞–ø–∞–∑–∏</button>
    <div class="sep"></div>
    <button id="btnSearch" class="btn">–¢—ä—Ä—Å–µ–Ω–µ</button>
    <span id="hint">‚úçÔ∏è –°–∞–º–æ –ø–∏—Å–∞–ª–∫–∞</span>
  </div>

  <div class="pen-badge" title="–°–∞–º–æ –ø–∏—Å–∞–ª–∫–∞">üñäÔ∏è</div>

  <div class="stage">
    <div class="board-wrap"><canvas id="board"></canvas></div>
    <aside id="searchPanel" class="panel" aria-label="–¢—ä—Ä—Å–µ–Ω–µ">
      <h3>–¢—ä—Ä—Å–µ–Ω–µ</h3>
      <div class="field">
        <input id="q" type="search" placeholder="–ò–º–µ‚Ä¶" list="suggestions" autocomplete="off"/>
        <datalist id="suggestions"></datalist>
        <span id="sum" class="pill">0.00 –ª–≤</span>
      </div>
      <div id="rows" class="list" aria-live="polite"></div>
    </aside>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ==== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ==== */
const OCR_URL = 'https://ocr-980985905017.europe-west1.run.app';

/* ==== IndexedDB: –≤—Å—è–∫–æ —Å—Ä–µ—â–∞–Ω–µ –æ—Ç–¥–µ–ª–Ω–æ (–±–µ–∑ –∞–≥—Ä–µ–≥–∞—Ü–∏—è/—Å–ª–∏–≤–∞–Ω–µ) ==== */
const DB='veresia-db', ENTRIES='entries', VER=2;
function withDB(mode, fn){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(DB,VER);
    r.onupgradeneeded=()=>{
      const db=r.result;
      if(!db.objectStoreNames.contains(ENTRIES)){
        const s=db.createObjectStore(ENTRIES,{keyPath:'id',autoIncrement:true});
        s.createIndex('by_name','nameLower',{unique:false});
        s.createIndex('by_ts','ts',{unique:false});
      }
    };
    r.onerror=()=>rej(r.error);
    r.onsuccess=()=>{
      const tx=r.result.transaction(ENTRIES,mode);
      const s=tx.objectStore(ENTRIES);
      Promise.resolve(fn(s)).then(v=>{tx.oncomplete=()=>res(v)},rej);
      tx.onerror=()=>rej(tx.error);
    };
  });
}
const store={
  add(e){
    const rec={
      name:String(e.name||'').trim(),                // –ù–ï –ø—Ä–æ–º–µ–Ω—è–º–µ –±—É–∫–≤–∏
      nameLower:String(e.name||'').trim().toLowerCase(),
      amount:Number(e.amount||0),
      ts:e.ts||Date.now(),
      sheetId:e.sheetId||null,
      raw:e.raw??null
    };
    return withDB('readwrite',s=>new Promise((res,rej)=>{
      const p=s.add(rec); p.onsuccess=()=>res(p.result); p.onerror=()=>rej(p.error);
    }));
  },
  all(){
    return withDB('readonly',s=>new Promise((res,rej)=>{
      const out=[]; const c=s.index('by_ts').openCursor(null,'prev'); // –Ω–æ–≤–∏—Ç–µ –¥–∞ —Å–∞ –Ω–∞–π-–æ—Ç–≥–æ—Ä–µ
      c.onsuccess=()=>{const cur=c.result;if(cur){out.push(cur.value);cur.continue()}else res(out)};
      c.onerror=()=>rej(c.error);
    }));
  },
  filterByName(term){
    const t=(term||'').trim().toLowerCase();
    if(!t) return this.all();
    return withDB('readonly',s=>new Promise((res,rej)=>{
      const out=[]; const c=s.index('by_ts').openCursor(null,'prev');
      c.onsuccess=()=>{const cur=c.result;if(cur){if(cur.value.nameLower.includes(t)) out.push(cur.value);cur.continue()}else res(out)};
      c.onerror=()=>rej(c.error);
    }));
  }
};

/* ==== Canvas (—Å–∞–º–æ –ø–∏—Å–∞–ª–∫–∞) ==== */
const canvas=document.getElementById('board');
const ctx=canvas.getContext('2d',{willReadFrequently:true});
let drawing=false,last=null;
function resize(){const dpr=window.devicePixelRatio||1;const r=canvas.getBoundingClientRect();canvas.width=Math.floor(r.width*dpr);canvas.height=Math.floor(r.height*dpr);ctx.setTransform(dpr,0,0,dpr,0,0);ctx.lineJoin='round';ctx.lineCap='round';ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--ink').trim()||'#fff';}
addEventListener('resize',resize,{passive:true});
addEventListener('orientationchange',()=>setTimeout(resize,50),{passive:true});
resize();
const isPen=e=>e.pointerType==='pen';
const pos=e=>{const r=canvas.getBoundingClientRect();return {x:e.clientX-r.left,y:e.clientY-r.top,p:e.pressure||0.5}};
canvas.addEventListener('pointerdown',e=>{if(!isPen(e))return;e.preventDefault();drawing=true;last=pos(e)});
canvas.addEventListener('pointermove',e=>{if(!drawing||!isPen(e))return;const p=pos(e);ctx.lineWidth=2+p.p*3.5;ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;});
const stop=()=>{drawing=false;last=null};canvas.addEventListener('pointerup',stop);canvas.addEventListener('pointercancel',stop);canvas.addEventListener('pointerleave',stop);

/* ==== UI helpers ==== */
const toastEl=document.getElementById('toast'); const hint=document.getElementById('hint');
function toast(m,ms=2200){toastEl.textContent=m;toastEl.classList.add('show');clearTimeout(toastEl._t);toastEl._t=setTimeout(()=>toastEl.classList.remove('show'),ms)}
function setHint(t){hint.textContent=t}

/* ==== –¢—ä—Ä—Å–∞—á–∫–∞ (–±–µ–∑ –∞–≥—Ä–µ–≥–∞—Ü–∏—è, –ø–æ–∫–∞–∑–≤–∞ –≤—Å–µ–∫–∏ –∑–∞–ø–∏—Å) ==== */
const panel=document.getElementById('searchPanel'); const btnSearch=document.getElementById('btnSearch');
const q=document.getElementById('q'); const rowsEl=document.getElementById('rows'); const sumEl=document.getElementById('sum'); const sugg=document.getElementById('suggestions');

btnSearch.onclick=async()=>{panel.classList.toggle('open');resize();if(panel.classList.contains('open')){await refillSuggestions();render(await store.filterByName(q.value||''));q.focus()}};

async function refillSuggestions(){
  const all=await store.all();
  const uniq=[...new Set(all.map(x=>x.name))].sort((a,b)=>a.localeCompare(b,'bg'));
  sugg.innerHTML=''; uniq.forEach(n=>{const o=document.createElement('option');o.value=n;sugg.appendChild(o)});
}
async function render(list){
  rowsEl.innerHTML='';
  let sum=0;
  list.forEach(r=>{
    sum+=Number(r.amount)||0;
    const d=document.createElement('div');
    const when=new Date(r.ts||Date.now());
    d.className='row';
    d.innerHTML=`<span>${r.name} <small>${when.toLocaleString()}</small></span><strong>${(+r.amount).toFixed(2)} –ª–≤</strong>`;
    rowsEl.appendChild(d);
  });
  sumEl.textContent=`${sum.toFixed(2)} –ª–≤`;
}
q.addEventListener('input',async()=>render(await store.filterByName(q.value)));

/* ==== Fallback –ø–∞—Ä—Å–µ—Ä (–ù–ï –∫–æ—Ä–∏–≥–∏—Ä–∞ –±—É–∫–≤–∏) ==== */
function parseBulgarian(text){
  const out=[]; // –ù–ï –ø—Ä–æ–º–µ–Ω—è–º–µ –∫–∞–∫–≤–æ –µ —Ä–∞–∑–ø–æ–∑–Ω–∞—Ç–æ (–æ—Å–≤–µ–Ω –∑–∞–ø–µ—Ç–∞—è –∫—ä–º —Ç–æ—á–∫–∞ –∑–∞ —á–∏—Å–ª–∞—Ç–∞)
  const rx=/([\p{Script=Cyrillic}\s'‚Äô.\-]{2,50})\s*[-=:]\s*([0-9]{1,5}(?:[.,][0-9]{1,2})?)/gu;
  let m; while((m=rx.exec(String(text||'')))!==null){
    const name=String(m[1]).trim();
    const amt=parseFloat(String(m[2]).replace(',', '.'));
    if(name && Number.isFinite(amt)) out.push({name,amount:+amt.toFixed(2)});
  }
  return out;
}

/* ==== OCR –∫–ª–∏–µ–Ω—Ç ==== */
async function ocrRecognize(dataUrl){
  const r=await fetch(OCR_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image:dataUrl})});
  const j=await r.json().catch(()=>({ok:false,error:'bad json'}));
  if(!r.ok || j.ok===false) throw new Error(j.error||`HTTP ${r.status}`);
  if(Array.isArray(j.entries) && j.entries.length){
    return j.entries.map(e=>({name:String(e.name||'').trim(),amount:Number(e.amount||0)}))
                    .filter(e=>e.name && Number.isFinite(e.amount));
  }
  return parseBulgarian(j.text||'');
}

/* ==== –ó–∞–ø–∞–∑–∏ (PNG ‚Üí OCR –≤—ä–≤ —Ñ–æ–Ω ‚Üí –∑–∞–ø–∏—Å *–≤—Å–µ–∫–∏ —Ä–µ–¥*) ==== */
const btnSave=document.getElementById('btnSave');
function pngDataUrl(){return canvas.toDataURL('image/png')}
function clearBoard(){ctx.clearRect(0,0,canvas.width,canvas.height)}
function newSheetId(){return 'sheet_'+Date.now()}

btnSave.onclick=async()=>{
  try{
    btnSave.disabled=true; setHint('–ó–∞–ø–∏—Å: —Å–Ω–∏–º–∫–∞‚Ä¶');
    const png=pngDataUrl();
    const a=document.createElement('a'); a.href=png; a.download=`veresia-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`; document.body.appendChild(a); a.click(); setTimeout(()=>a.remove(),0);

    clearBoard(); const sheetId=newSheetId(); setHint('OCR‚Ä¶');
    (async()=>{
      try{
        const items=await ocrRecognize(png);
        if(items.length){
          for(const it of items){ await store.add({sheetId,name:it.name,amount:it.amount,ts:Date.now(),raw:null}); }
          toast(`–ó–∞–ø–∏—Å–∞–Ω–∏ —Ä–µ–¥–æ–≤–µ: ${items.length}`);
          if(panel.classList.contains('open')) render(await store.filterByName(q.value||''));
        }else{
          toast('–ù–µ –æ—Ç–∫—Ä–∏—Ö ‚Äû–ò–º–µ - —Å—É–º–∞‚Äú.'); 
        }
      }catch(err){ console.error(err); toast('OCR –≥—Ä–µ—à–∫–∞ (–≤–∏–∂ –∫–æ–Ω–∑–æ–ª–∞—Ç–∞)'); }
      finally{ setHint('‚úçÔ∏è –°–∞–º–æ –ø–∏—Å–∞–ª–∫–∞'); btnSave.disabled=false; }
    })();
  }catch(e){ console.error(e); toast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ ‚Äû–ó–∞–ø–∞–∑–∏‚Äú'); setHint('–ì—Ä–µ—à–∫–∞'); btnSave.disabled=false; }
};
</script>
</body>
</html>
