<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Veresia</title>
<style>
  :root{--bg:#0e1116;--line:#1e3558;--ink:#f8fafc}
  html,body{margin:0;height:100%;background:#0b0f14;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;touch-action:none}
  .topbar{position:fixed;inset:0 0 auto 0;display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:rgba(11,15,20,.65);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06);z-index:5}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.18);color:#e5e7eb;background:transparent;padding:.45rem .7rem;border-radius:.5rem;font-size:.95rem;cursor:pointer}
  .btn:hover{border-color:#ffffff44}
  .btn.primary{border-color:#60a5fa;background:#1e293b}
  .sep{flex:1}
  .stage{position:fixed;inset:44px 0 0 0;display:grid;grid-template-columns:1fr auto}
  .board-wrap{position:relative;overflow:hidden}
  canvas#board{
    width:100%;height:100%;display:block;touch-action:none;
    background:
      repeating-linear-gradient(to bottom,
        var(--bg) 0px, var(--bg) 26px,
        var(--line) 26px, var(--line) 27px);
  }
  .panel{width:min(360px,92vw);background:#0b1220;border-left:1px solid #1f2a44;padding:.75rem;display:none}
  .panel.open{display:block}
  .panel h3{margin:.2rem 0 .6rem;font-weight:600}
  .field{display:flex;gap:.5rem;align-items:center;margin:.25rem 0 .75rem}
  .field input{flex:1;padding:.45rem .6rem;border-radius:.45rem;background:#0c1426;color:#e5e7eb;border:1px solid #24314f}
  .pill{font-size:.8rem;padding:.2rem .45rem;border:1px solid #2b3b64;border-radius:999px}
  .list{font-size:.95rem;line-height:1.4}
  .list div{display:flex;justify-content:space-between;padding:.35rem .2rem;border-bottom:1px dashed #1c2744}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111827;border:1px solid #374151;padding:.6rem .8rem;border-radius:.6rem;z-index:10;display:none}
  .toast.show{display:block}
  #hint{font-size:.85rem;opacity:.9}
  .pen-badge{position:fixed;right:.6rem;top:.6rem;z-index:6;width:36px;height:36px;border-radius:50%;display:grid;place-items:center;background:#0c1426;border:1px solid #223152}
</style>
</head>
<body>
  <div class="topbar">
    <strong>Veresia</strong>
    <button id="btnSave" class="btn primary">–ó–∞–ø–∞–∑–∏</button>
    <div class="sep"></div>
    <button id="btnSearch" class="btn">–¢—ä—Ä—Å–µ–Ω–µ</button>
    <span id="hint">‚úçÔ∏è –°–∞–º–æ –ø–∏—Å–∞–ª–∫–∞</span>
  </div>

  <div class="pen-badge" title="–°–∞–º–æ –ø–∏—Å–∞–ª–∫–∞">üñäÔ∏è</div>

  <div class="stage">
    <div class="board-wrap">
      <canvas id="board"></canvas>
    </div>
    <aside id="searchPanel" class="panel" aria-label="–¢—ä—Ä—Å–µ–Ω–µ">
      <h3>–¢—ä—Ä—Å–µ–Ω–µ</h3>
      <div class="field">
        <input id="q" type="search" placeholder="–ò–º–µ‚Ä¶" list="suggestions" autocomplete="off"/>
        <datalist id="suggestions"></datalist>
        <span id="sum" class="pill">0.00 –ª–≤</span>
      </div>
      <div id="rows" class="list" aria-live="polite"></div>
    </aside>
  </div>

  <div id="toast" class="toast"></div>

<script type="module">
/* ====== –ù–ê–°–¢–†–û–ô–ö–ê ====== */
const OCR_URL = 'https://ocr-980985905017.europe-west1.run.app';

/* ====== IndexedDB v2: entries (–≤—Å—è–∫–æ —Å—Ä–µ—â–∞–Ω–µ –æ—Ç–¥–µ–ª–Ω–æ) + legacy –º–∏–≥—Ä–∞—Ü–∏—è ====== */
const DB='veresia-db', ENTRIES='entries', LEGACY='names', VER=2;
function withDB(mode, store, fn){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(DB,VER);
    r.onupgradeneeded=()=>{
      const db=r.result;
      if(!db.objectStoreNames.contains(ENTRIES)){
        const s=db.createObjectStore(ENTRIES,{keyPath:'id',autoIncrement:true});
        s.createIndex('by_name','nameLower',{unique:false});
        s.createIndex('by_sheet','sheetId',{unique:false});
      }
      // legacy store –æ—Å—Ç–∞–≤—è–º–µ –∞–∫–æ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞ (–∑–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ø–æ-–∫—ä—Å–Ω–æ)
      if(!db.objectStoreNames.contains(LEGACY)){
        // –Ω–∏—â–æ, –º–æ–∂–µ –¥–∞ –≥–æ –Ω—è–º–∞
      }
    };
    r.onerror=()=>rej(r.error);
    r.onsuccess=()=>{
      const tx=r.result.transaction(store,mode);
      const s=tx.objectStore(store);
      Promise.resolve(fn(s)).then(v=>{
        tx.oncomplete=()=>res(v);
      },rej);
      tx.onerror=()=>rej(tx.error);
    };
  });
}
const idb={
  async addEntry(e){
    const rec={
      sheetId:e.sheetId,
      name:String(e.name||'').trim(),
      nameLower:String(e.name||'').trim().toLowerCase(),
      amount:Number(e.amount||0),
      ts:e.ts||Date.now(),
      raw:e.raw||null
    };
    return withDB('readwrite',ENTRIES,s=>new Promise((res,rej)=>{
      const p=s.add(rec); p.onsuccess=()=>res(p.result); p.onerror=()=>rej(p.error);
    }));
  },
  listAll(){
    return withDB('readonly',ENTRIES,s=>new Promise((res,rej)=>{
      const out=[];const c=s.openCursor();
      c.onsuccess=()=>{const cur=c.result;if(cur){out.push(cur.value);cur.continue()}else res(out)};
      c.onerror=()=>rej(c.error);
    }));
  },
  listByName(term){
    const t=(term||'').trim().toLowerCase();
    if(!t) return this.listAll();
    return withDB('readonly',ENTRIES,s=>new Promise((res,rej)=>{
      const idx=s.index('by_name'); const out=[]; const c=idx.openCursor();
      c.onsuccess=()=>{const cur=c.result;if(cur){const v=cur.value;if(v.nameLower.includes(t)) out.push(v);cur.continue()}else res(out)};
      c.onerror=()=>rej(c.error);
    }));
  }
};

// –º–∏–≥—Ä–∞—Ü–∏—è –æ—Ç legacy 'names' (–∞–∫–æ –∏–º–∞) –∫—ä–º entries (–µ–¥–∏–Ω–∏—á–Ω–∏ —Å—Ä–µ—â–∞–Ω–∏—è)
async function migrateLegacyOnce(){
  // –ø—Ä–æ–≤–µ—Ä—è–≤–∞–º–µ –¥–∞–ª–∏ –∏–º–∞ legacy store –∏–∑–æ–±—â–æ
  const r=indexedDB.open(DB,VER);
  const hasLegacy=await new Promise(ok=>{
    r.onupgradeneeded=()=>ok(false);
    r.onsuccess=()=>{
      const db=r.result;
      ok(db.objectStoreNames.contains(LEGACY));
    };
    r.onerror=()=>ok(false);
  });
  if(!hasLegacy) return;
  // —á–µ—Ç–∏ legacy –∏ –ø—Ä–µ—Ö–≤—ä—Ä–ª—è–π
  const legacy=await new Promise((res,rej)=>{
    const r2=indexedDB.open(DB,VER);
    r2.onsuccess=()=>{
      const tx=r2.result.transaction(LEGACY,'readonly');
      const s=tx.objectStore(LEGACY);
      const out=[];
      const c=s.openCursor();
      c.onsuccess=()=>{const cur=c.result;if(cur){out.push(cur.value);cur.continue()}else res(out)};
      c.onerror=()=>rej(c.error);
    };
    r2.onerror=()=>rej(r2.error);
  });
  if(!legacy || !legacy.length) return;
  // —Ä–∞–∑–¥—É–π items –∫—ä–º entries
  for(const rec of legacy){
    if(Array.isArray(rec.items)){
      for(const it of rec.items){
        await idb.addEntry({
          sheetId:'legacy',
          name:rec.name,
          amount:it.amount,
          ts:it.ts||Date.now(),
          raw:{legacy:true}
        });
      }
    }
  }
}

/* ====== UI / Canvas ====== */
const canvas=document.getElementById('board');
const ctx=canvas.getContext('2d',{willReadFrequently:true});
let drawing=false,last=null;

function resize(){
  const dpr=window.devicePixelRatio||1;
  const r=canvas.getBoundingClientRect();
  canvas.width=Math.floor(r.width*dpr); canvas.height=Math.floor(r.height*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.lineJoin='round'; ctx.lineCap='round'; ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--ink').trim()||'#fff';
}
addEventListener('resize',resize,{passive:true});
addEventListener('orientationchange',()=>setTimeout(resize,50),{passive:true});
resize();

const isPen=e=>e.pointerType==='pen';
const pos=e=>{const r=canvas.getBoundingClientRect();return {x:e.clientX-r.left,y:e.clientY-r.top,p:e.pressure||0.5}};
canvas.addEventListener('pointerdown',e=>{if(!isPen(e))return;e.preventDefault();drawing=true;last=pos(e)});
canvas.addEventListener('pointermove',e=>{if(!drawing||!isPen(e))return;const p=pos(e);ctx.lineWidth=2+p.p*3.5;ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p;});
const stop=()=>{drawing=false;last=null}; canvas.addEventListener('pointerup',stop);canvas.addEventListener('pointercancel',stop);canvas.addEventListener('pointerleave',stop);

// toast + hint
const toastEl=document.getElementById('toast'); const hintEl=document.getElementById('hint');
function toast(m,ms=2200){toastEl.textContent=m;toastEl.classList.add('show');clearTimeout(toastEl._t);toastEl._t=setTimeout(()=>toastEl.classList.remove('show'),ms)}
function setHint(t){hintEl.textContent=t}

/* ====== –¢—ä—Ä—Å–µ–Ω–µ (–∞–≥—Ä–µ–≥–∏—Ä–∞–Ω–µ –ø–æ –∏–º–µ, –Ω–æ –∑–∞–ø–∏—Å–∏—Ç–µ —Å–∞ –æ—Ç–¥–µ–ª–Ω–∏) ====== */
const panel=document.getElementById('searchPanel');
const btnSearch=document.getElementById('btnSearch');
const q=document.getElementById('q');
const rowsEl=document.getElementById('rows');
const sumEl=document.getElementById('sum');
const sugg=document.getElementById('suggestions');

btnSearch.onclick=async()=>{panel.classList.toggle('open');resize(); if(panel.classList.contains('open')){await refreshSuggestions(); const rs=await search(''); render(rs);}};

async function refreshSuggestions(){
  const all=await idb.listAll();
  const uniq=[...new Set(all.map(x=>x.name))].sort((a,b)=>a.localeCompare(b,'bg'));
  sugg.innerHTML=''; uniq.forEach(n=>{const o=document.createElement('option');o.value=n;sugg.appendChild(o)})
}
async function search(term){
  const rows=await idb.listByName(term);
  const map=new Map();
  for(const r of rows){
    const k=r.name;
    const cur=map.get(k)||{name:k,total:0,items:[]};
    cur.total=+(cur.total+(r.amount||0)).toFixed(2);
    cur.items.push({id:r.id,amount:r.amount,ts:r.ts,sheetId:r.sheetId});
    map.set(k,cur);
  }
  const agg=[...map.values()].sort((a,b)=>a.name.localeCompare(b.name,'bg'));
  const s=agg.reduce((t,x)=>t+x.total,0);
  return {rows:agg,sum:s};
}
function render({rows,sum}){
  rowsEl.innerHTML='';
  rows.forEach(r=>{
    const count=r.items?.length||0;
    const d=document.createElement('div');
    d.innerHTML=`<span>${r.name}${count>1?` <small style="opacity:.7">(${count}√ó)</small>`:''}</span><strong>${r.total.toFixed(2)} –ª–≤</strong>`;
    rowsEl.appendChild(d);
  });
  sumEl.textContent=`${(sum||0).toFixed(2)} –ª–≤`;
}
q.addEventListener('input',async()=>{const rs=await search(q.value); render(rs)});

/* ====== –ß–∏—Å—Ç –∫–∏—Ä–∏–ª–∏—á–µ–Ω –ø–∞—Ä—Å–µ—Ä (fallback, –∞–∫–æ –±–µ–∫–µ–Ω–¥—ä—Ç –Ω–µ –≤—ä—Ä–Ω–µ entries) ====== */
function parseBulgarian(text){
  const out=[]; const norm=(s)=>String(s||'').normalize('NFC').replace(/[‚Äì‚Äî‚àí]/g,'-');
  const rx=/([\p{Script=Cyrillic}\s'‚Äô.\-]{2,50})\s*[-=:]\s*([0-9]{1,5}(?:[.,][0-9]{1,2})?)/gu;
  const clean=(s)=>String(s||'').normalize('NFC').replace(/[^\p{Script=Cyrillic}\s'‚Äô.\-]/gu,' ').replace(/\s+/g,' ').trim();
  let m; const textN=norm(text);
  while((m=rx.exec(textN))!==null){
    const name=clean(m[1]); const amt=parseFloat(String(m[2]).replace(',', '.'));
    if(name && Number.isFinite(amt)) out.push({name,amount:+amt.toFixed(2)});
  }
  return out;
}

/* ====== OCR –ø–æ–≤–∏–∫–≤–∞–Ω–µ –∫—ä–º Cloud Run (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ) ====== */
async function ocrRecognize(dataUrl){
  const r=await fetch(OCR_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image:dataUrl})});
  const j=await r.json().catch(()=>({ok:false,error:'Bad JSON'}));
  if(!r.ok || j.ok===false) throw new Error(j.error||`HTTP ${r.status}`);
  // –æ—á–∞–∫–≤–∞–º–µ { ok:true, text, entries? }
  let entries=[];
  if(Array.isArray(j.entries) && j.entries.length){
    // —Ç–≤—ä—Ä–¥–æ –ø–∞–∑–∏–º —Å–∞–º–æ –∫–∏—Ä–∏–ª–∏—Ü–∞
    entries = j.entries.map(e=>({
      name: String(e.name||'').normalize('NFC').replace(/[^\p{Script=Cyrillic}\s'‚Äô.\-]/gu,' ').replace(/\s+/g,' ').trim(),
      amount: Number(e.amount||0)
    })).filter(e=>e.name && Number.isFinite(e.amount));
  }else{
    entries = parseBulgarian(j.text||'');
  }
  return entries;
}

/* ====== –ó–∞–ø–∞–∑–∏ (PNG ‚Üí OCR –≤—ä–≤ —Ñ–æ–Ω ‚Üí –∑–∞–ø–∏—Å –Ω–∞ –æ—Ç–¥–µ–ª–Ω–∏ —Å—Ä–µ—â–∞–Ω–∏—è) ====== */
const btnSave=document.getElementById('btnSave');
function dataUrl(){return canvas.toDataURL('image/png')}
function clearBoard(){ctx.clearRect(0,0,canvas.width,canvas.height)}
function makeSheetId(){return 'sheet_'+new Date().toISOString().replace(/[:.]/g,'-').slice(0,19)}

btnSave.onclick=async()=>{
  try{
    btnSave.disabled=true; setHint('–ó–∞–ø–∏—Å: —Å–Ω–∏–º–∫–∞‚Ä¶');
    const png=dataUrl();
    // —Å–≤–∞–ª—è–Ω–µ –Ω–∞ PNG
    const a=document.createElement('a'); a.href=png; a.download=`veresia-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
    document.body.appendChild(a); a.click(); setTimeout(()=>a.remove(),0);

    // –Ω–æ–≤ –ª–∏—Å—Ç –≤–µ–¥–Ω–∞–≥–∞
    clearBoard(); setHint('OCR‚Ä¶');
    const sheetId=makeSheetId();

    // OCR –≤—ä–≤ —Ñ–æ–Ω (–¥–∞ –º–æ–∂–µ—à –¥–∞ –ø–∏—à–µ—à)
    (async()=>{
      try{
        const entries=await ocrRecognize(png);
        if(entries.length){
          for(const e of entries){
            await idb.addEntry({sheetId,name:e.name,amount:e.amount,ts:Date.now(),raw:null});
          }
          toast(`–ó–∞–ø–∏—Å–∞–Ω–∏ —Ä–µ–¥–æ–≤–µ: ${entries.length}`);
          if(panel.classList.contains('open')){
            const rs=await search(q.value||''); render(rs);
          }
        }else{
          toast('–ù–µ –æ—Ç–∫—Ä–∏—Ö ‚Äû–ò–º–µ - —Å—É–º–∞‚Äú');
        }
      }catch(err){
        console.error(err); toast('OCR –≥—Ä–µ—à–∫–∞ (–∫–æ–Ω–∑–æ–ª–∞)');
      }finally{
        setHint('‚úçÔ∏è –°–∞–º–æ –ø–∏—Å–∞–ª–∫–∞'); btnSave.disabled=false;
      }
    })();

  }catch(e){
    console.error(e); toast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ ‚Äû–ó–∞–ø–∞–∑–∏‚Äú'); setHint('–ì—Ä–µ—à–∫–∞'); btnSave.disabled=false;
  }
};

/* ====== –°—Ç–∞—Ä—Ç ====== */
window.addEventListener('DOMContentLoaded', async ()=>{
  await migrateLegacyOnce();
  if(panel.classList.contains('open')){
    const rs=await search(''); render(rs);
  }
});
</script>
</body>
</html>
