<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Veresia – Power Pipeline (Stylus-only · Handwrite→Print · Dual OCR)</title>
<style>
  :root{--bg:#0c1530;--line:#1d2b5c;--panel:#0b1220;--text:#e5e7eb;--border:#24314f}
  html,body{margin:0;height:100%;background:#0b0f14;color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .topbar{position:fixed;inset:0 0 auto 0;display:flex;gap:.5rem;align-items:center;padding:.55rem .8rem;background:rgba(11,15,20,.75);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.06);z-index:10}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.18);color:var(--text);background:transparent;padding:.45rem .7rem;border-radius:.5rem;font-size:.95rem;cursor:pointer;touch-action:manipulation}
  .btn:hover{border-color:#ffffff44}
  .btn.primary{border-color:#60a5fa;background:#1e293b}
  .sep{flex:1}
  .stage{position:fixed;inset:48px 0 0 0;display:grid;grid-template-columns:1fr 380px}
  .board-wrap{position:relative;overflow:hidden}
  canvas#display{
    width:100%;height:100%;display:block;touch-action:none;
    background:repeating-linear-gradient(to bottom,var(--bg) 0,var(--bg) 26px,var(--line) 26px,var(--line) 27px);
  }
  canvas#ocr{position:absolute;inset:0;opacity:0;pointer-events:none}
  aside.panel{background:var(--panel);border-left:1px solid #1f2a44;padding:.6rem .6rem 80px;overflow:auto}
  .h2{margin:.2rem 0 .4rem;font-weight:600}
  .hint{opacity:.85;font-size:.85rem}
  .queue{display:grid;gap:.6rem;margin-top:.6rem}
  .card{border:1px solid var(--border);border-radius:.6rem;overflow:hidden;background:#0b0f14}
  .card header{display:flex;align-items:center;gap:.5rem;padding:.42rem .55рем;border-bottom:1px solid #1c2744}
  .thumb{display:block;max-width:100%;background:#fff}
  .row{display:flex;gap:.4rem;align-items:center;padding:.45rem .55rem}
  .row input{flex:1;padding:.45rem .55rem;border-radius:.45rem;background:#0c1426;color:var(--text);border:1px solid #24314f}
  .actions{display:flex;gap:.4rem;flex-wrap:wrap;padding:.42rem .55rem;border-top:1px dashed #1c2744}
  .chip{border:1px solid #2b3b64;border-radius:999px;padding:.28rem .6rem;cursor:pointer;background:#0c1426}
  .chip:hover{border-color:#4c68a8}
  .ok{background:#12321b;border-color:#1f7a3d}
  .danger{background:#321212;border-color:#7a1f1f}
  .pill{font-size:.8rem;padding:.2rem .45rem;border:1px solid #2b3b64;border-radius:999px}
  .small{font-size:.85rem;opacity:.9;margin-left:auto}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111827;border:1px solid #374151;padding:.6rem .8rem;border-radius:.6rem;z-index:11;display:none;pointer-events:none}
  .toast.show{display:block}
  .searchbox{display:flex;gap:.4rem;margin-top:.5rem}
  .searchbox input{flex:1;padding:.45rem .6rem;border-radius:.45rem;background:#0c1426;color:var(--text);border:1px solid #24314f}
  .res{display:grid;gap:.2rem;margin-top:.4rem}
  .res div{display:flex;justify-content:space-between;gap:.75rem;padding:.3rem .2rem;border-bottom:1px dashed #1c2744}
</style>
</head>
<body>
  <div class="topbar">
    <strong>Veresia</strong>
    <button id="btnSave" class="btn primary">Запази</button>
    <button id="btnPreview" class="btn">OCR преглед</button>
    <button id="btnSearch" class="btn">Търсене</button>
    <span class="sep"></span>
    <span class="hint">Stylus-only • Handwrite→Print • Dual OCR</span>
  </div>

  <div class="stage">
    <div class="board-wrap">
      <canvas id="display"></canvas>
      <canvas id="ocr"></canvas>
    </div>
    <aside class="panel">
      <div class="h2">Опашка „За преглед“ (редактираемо име)</div>
      <div class="hint">Ако името не е точно, коригирай полето и натисни „Приеми“.</div>
      <div id="queue" class="queue"></div>

      <hr style="border:0;border-top:1px solid #1c2744;margin:.6rem 0">
      <div class="h2">Търсене</div>
      <div class="searchbox">
        <input id="q" type="search" placeholder="Име… (live)" autocomplete="off"/>
        <span id="sum" class="pill">0.00 лв</span>
      </div>
      <div id="rows" class="res"></div>
    </aside>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Локален OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
  /*** КОНФИГ ***/
  let OCR_URL = "https://ocr-980985905017.europe-west1.run.app"; // <— СМЕНИ С ТВОЯ
  if(!/\/ocr\/?$/.test(OCR_URL)) OCR_URL = OCR_URL.replace(/\/?$/, "/ocr");
  const USE_CLOUD_FALLBACK = true;
  const CLIENT_CONF_THRESHOLD = 0.86;
  const AUTO_ACCEPT_THRESHOLD = 0.93;

  /*** IndexedDB ***/
  const DB_NAME='veresia-db', STORE='entries', DB_VER=1;
  function withDB(mode,fn){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VER);
    r.onupgradeneeded=()=>{const db=r.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE,{keyPath:'id'})};
    r.onerror=()=>rej(r.error);
    r.onsuccess=()=>{const tx=r.result.transaction(STORE,mode);const s=tx.objectStore(STORE);
      Promise.resolve(fn(s)).then(v=>{tx.oncomplete=()=>res(v);tx.onerror=()=>rej(tx.error);},rej);} })}
  const db={
    add: obj=>withDB('readwrite',s=>s.put(obj)),
    all: ()=>withDB('readonly',s=>new Promise((res,rej)=>{const out=[];const c=s.openCursor();c.onsuccess=()=>{const cur=c.result;if(cur){out.push(cur.value);cur.continue()}else res(out)};c.onerror=()=>rej(c.error)}))
  };

  /*** UI ***/
  const toastEl=document.getElementById('toast');
  function toast(m,ms=2100){toastEl.textContent=m;toastEl.classList.add('show');clearTimeout(toastEl._t);toastEl._t=setTimeout(()=>toastEl.classList.remove('show'),ms)}
  const queueEl=document.getElementById('queue'); const qEl=document.getElementById('q'); const rowsEl=document.getElementById('rows'); const sumEl=document.getElementById('sum');

  /*** Канваси ***/
  const display=document.getElementById('display');
  const ocr=document.getElementById('ocr');
  const dCtx=display.getContext('2d',{willReadFrequently:true});
  const oCtx=ocr.getContext('2d',{willReadFrequently:true});

  function resize(){
    const dpr=window.devicePixelRatio||1;
    const r=display.getBoundingClientRect();
    [display,ocr].forEach(c=>{c.width=Math.floor(r.width*dpr);c.height=Math.floor(r.height*dpr);c.style.width=r.width+'px';c.style.height=r.height+'px';});
    dCtx.setTransform(dpr,0,0,dpr,0,0); oCtx.setTransform(dpr,0,0,dpr,0,0);
    dCtx.lineJoin='round'; dCtx.lineCap='round'; dCtx.strokeStyle='#ffffff'; dCtx.lineWidth=3.5;
    oCtx.fillStyle='#ffffff'; oCtx.fillRect(0,0,ocr.width,ocr.height);
    oCtx.lineJoin='round'; oCtx.lineCap='round'; oCtx.strokeStyle='#000000'; oCtx.lineWidth=4.8;
  }
  window.addEventListener('resize',resize,{passive:true});
  window.addEventListener('orientationchange',()=>setTimeout(resize,50),{passive:true});
  document.addEventListener('DOMContentLoaded',resize);

  // Stylus-only (допуска „touch стилус“ по pressure/tilt)
  function isStylus(e){
    if(e.pointerType==='pen') return true;
    if(e.pointerType==='touch' && (e.pressure>0.1 || Math.abs(e.tiltX||0)+Math.abs(e.tiltY||0)>0)) return true;
    return false;
  }
  let drawing=false,last=null, dirty=null;
  function pos(e,el){const r=el.getBoundingClientRect();return {x:e.clientX-r.left,y:e.clientY-r.top,p:e.pressure||0.5}}

  display.addEventListener('pointerdown',e=>{
    if(!isStylus(e)){ toast('Само със стилус ✍️'); return; }
    e.preventDefault(); display.setPointerCapture(e.pointerId);
    drawing=true; last=pos(e,display); dirty={x:last.x,y:last.y,x2:last.x,y2:last.y};
  }, {passive:false});

  display.addEventListener('pointermove',e=>{
    if(!drawing || !isStylus(e)) return;
    e.preventDefault();
    const p=pos(e,display); const w=2.5+p.p*3.8;
    dCtx.lineWidth=w; dCtx.beginPath(); dCtx.moveTo(last.x,last.y); dCtx.lineTo(p.x,p.y); dCtx.stroke();
    oCtx.lineWidth=Math.max(4.2,w*1.2); oCtx.beginPath(); oCtx.moveTo(last.x,last.y); oCtx.lineTo(p.x,p.y); oCtx.stroke();
    dirty.x=Math.min(dirty.x,p.x); dirty.y=Math.min(dirty.y,p.y); dirty.x2=Math.max(dirty.x2,p.x); dirty.y2=Math.max(dirty.y2,p.y);
    last=p;
  }, {passive:false});

  function handwriteToPrintRegion(x,y,w,h){
    const ctx=oCtx, img=ctx.getImageData(x,y,w,h), d=img.data;
    // локален контраст
    for(let i=0;i<d.length;i+=4){
      const Y=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];
      let v = Y<140 ? 0 : (Y>210 ? 255 : (Y-140)*255/70);
      d[i]=d[i+1]=d[i+2]=v; d[i+3]=255;
    }
    // адаптивна бинаризация 3x3
    const a=new Uint8ClampedArray(d); const idx=(xx,yy)=>((yy*w+xx)<<2);
    for(let yy=1;yy<h-1;yy++){
      for(let xx=1;xx<w-1;xx++){
        let s=0,c=0; for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){ s+=a[idx(xx+dx,yy+dy)]; c++; }
        const mean=s/c; const i=idx(xx,yy);
        const v=a[i] < (mean-12) ? 0 : 255;
        d[i]=d[i+1]=d[i+2]=v;
      }
    }
    ctx.putImageData(img,x,y);
  }
  function beautifyDirty(){
    if(!dirty) return;
    const pad=10;
    const x=Math.max(0,Math.floor(dirty.x-pad)), y=Math.max(0,Math.floor(dirty.y-pad));
    const w=Math.min(ocr.width-x, Math.ceil(dirty.x2-x+pad*2));
    const h=Math.min(ocr.height-y, Math.ceil(dirty.y2-y+pad*2));
    handwriteToPrintRegion(x,y,w,h);
    dirty=null;
  }
  function endStroke(e){ if(drawing){ drawing=false; beautifyDirty(); try{display.releasePointerCapture(e.pointerId)}catch{} } }
  ['pointerup','pointercancel','pointerleave'].forEach(ev=>display.addEventListener(ev,endStroke,{passive:true}));

  /*** OCR Preview ***/
  document.getElementById('btnPreview').onclick=()=>{
    const w=window.open('','_blank','width=900,height=700');
    w.document.write(`<img src="${ocr.toDataURL('image/png')}" style="max-width:100%"/>`);
    w.document.title='OCR Preview (Handwrite→Print)';
  };

  /*** Търсене ***/
  document.getElementById('btnSearch').onclick=()=>renderSearch(qEl.value||'');
  qEl.addEventListener('input',()=>renderSearch(qEl.value||''));
  async function renderSearch(term){
    const items=(await db.all()).filter(x=>!term || x.name.toLowerCase().includes(term.toLowerCase()));
    items.sort((a,b)=>a.name.localeCompare(b.name,'bg') || a.ts-b.ts);
    rowsEl.innerHTML=''; let total=0;
    for(const it of items){ total+=it.amount; const div=document.createElement('div'); div.innerHTML=`<span>${it.name}</span><span>${it.amount.toFixed(2)} лв</span>`; rowsEl.appendChild(div); }
    sumEl.textContent=total.toFixed(2)+' лв';
  }

  /*** Сегментация ***/
  function segmentBlocks(canvas){
    const ctx=canvas.getContext('2d',{willReadFrequently:true});
    const {width:w,height:h}=canvas; const img=ctx.getImageData(0,0,w,h); const d=img.data;
    const rowSum=new Float32Array(h);
    for(let y=0;y<h;y++){ let s=0; for(let x=0;x<w;x++){const i=(y*w+x)*4; const v=255-(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]); s+=v;} rowSum[y]=s/(w*255); }
    const sorted=Array.from(rowSum).sort((a,b)=>a-b); const med=sorted[Math.floor(h*0.5)]||0; const thr=Math.max(0.02, med*0.65);
    const bands=[]; let inBand=false,y1=0;
    for(let y=0;y<h;y++){ const ink=rowSum[y]>thr; if(ink && !inBand){inBand=true;y1=y}else if(!ink && inBand){inBand=false;bands.push([y1,y-1])}}
    if(inBand) bands.push([y1,h-1]); if(!bands.length) return [];
    const gaps=bands.slice(1).map((b,i)=>b[0]-bands[i][1]); const medianGap=gaps.length?gaps.sort((a,b)=>a-b)[Math.floor(gaps.length*0.5)]:0; const maxJoinGap=Math.max(3,Math.floor(medianGap*1.5)||14);
    const blocks=[]; let cur=bands[0].slice();
    for(let i=1;i<bands.length;i++){const b=bands[i]; if(b[0]-cur[1]<=maxJoinGap && (b[1]-cur[0])<=300){cur[1]=b[1]} else {blocks.push(cur);cur=b.slice()}}
    blocks.push(cur);
    const out=[]; for(const [yy1,yy2] of blocks){
      let minX=w,maxX=0;
      for(let y=yy1;y<=yy2;y++)for(let x=0;x<w;x++){const i=(y*w+x)*4; const v=255-(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]); if(v>40){ if(x<minX)minX=x; if(x>maxX)maxX=x; }}
      if(maxX-minX<10) continue; const pad=12; out.push({x:Math.max(0,minX-pad),y:Math.max(0,yy1-pad),w:Math.min(w,(maxX-minX)+2*pad),h:Math.min(h,(yy2-yy1)+2*pad)});
    }
    return out;
  }

  /*** Dual OCR ***/
  let tesseractWorker=null;
  async function getWorker(){ if(!tesseractWorker){ tesseractWorker=await Tesseract.createWorker('bul',1,{logger:()=>{}});} return tesseractWorker; }
  window.addEventListener('beforeunload',()=>{ if(tesseractWorker) tesseractWorker.terminate(); });

  function scaleForOCR(src, targetW=1800){
    const scale=Math.min(2400,Math.max(targetW,src.width))/src.width;
    const w=Math.round(src.width*scale), h=Math.round(src.height*scale);
    const c=document.createElement('canvas'); c.width=w; c.height=h;
    const cctx=c.getContext('2d'); cctx.fillStyle='#fff'; cctx.fillRect(0,0,w,h); cctx.imageSmoothingEnabled=true; cctx.drawImage(src,0,0,w,h);
    return c;
  }
  function handwriteToPrintCanvas(src){
    const c=scaleForOCR(src);
    const ctx=c.getContext('2d',{willReadFrequently:true});
    const {width:w,height:h}=c; const img=ctx.getImageData(0,0,w,h), d=img.data;
    for(let i=0;i<d.length;i+=4){ const Y=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; let v= (Y<150?0:(Y>210?255: (Y-150)*255/60)); d[i]=d[i+1]=d[i+2]=v; d[i+3]=255; }
    const a=new Uint8ClampedArray(d); const idx=(xx,yy)=>((yy*w+xx)<<2);
    for(let yy=1;yy<h-1;yy++)for(let xx=1;xx<w-1;xx++){
      let s=0,cnt=0; for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){ s+=a[idx(xx+dx,yy+dy)]; cnt++; }
      const mean=s/cnt; const i=idx(xx,yy); const v=a[i]<(mean-10)?0:255; d[i]=d[i+1]=d[i+2]=v;
    }
    ctx.putImageData(img,0,0); return c;
  }

  async function ocrLocalPrinted(canvas){
    const printed=handwriteToPrintCanvas(canvas);
    const worker=await getWorker();
    const { data } = await worker.recognize(printed);
    let conf=0; if(data?.words?.length){ conf=data.words.reduce((a,w)=>a+(w.confidence||0),0)/(100*data.words.length) } else if(typeof data?.confidence==='number'){ conf=(data.confidence||0)/100 }
    return { text:(data?.text||'').trim(), conf:Math.max(0,Math.min(1,conf||0)), preview:printed.toDataURL('image/png') };
  }
  async function ocrCloudFromDataURL(dataURL){
    const base64=dataURL.split(',')[1];
    const r=await fetch(OCR_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({imageBase64:base64})});
    const j=await r.json(); if(!r.ok||!j?.ok) throw new Error(j?.error||('HTTP '+r.status));
    return { text:(j.text||'').trim(), conf:0.9, entries:j.entries||[] };
  }

  /*** Парсинг „име – сума“ ***/
  function parseEntries(text){
    const results=[]; if(!text) return results;
    const norm=text.replace(/\u00A0/g,' ').replace(/[–—−]/g,'-');
    const joined=norm.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).join(' ').replace(/\s+/g,' ');
    const moneyRx=/([0-9]{1,4})(?:[.,]([0-9]{1,2}))?\s*(?:лв|лева)?/gi;
    let m, last=null;
    while((m=moneyRx.exec(joined))!==null){ const val=parseFloat(m[1]+'.'+(m[2]||'00')); last={start:m.index,end:moneyRx.lastIndex,amount:+val.toFixed(2)}; }
    if(!last) return results;
    let frag=joined.slice(0,last.start).replace(/[-=:]*\s*$/,'').trim();
    frag=frag.replace(/[^\p{Script=Cyrillic}\s.'’-]/gu,' ').replace(/\s+/g,' ').trim();
    if(frag) results.push({name:frag,amount:last.amount});
    return results;
  }

  /*** Анти-дубликати ***/
  const recentSet=new Set();
  async function sha(text){ const buf=new TextEncoder().encode(text); const dig=await crypto.subtle.digest('SHA-256',buf); return Array.from(new Uint8Array(dig)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

  /*** Картичка ***/
  function queueCard({imgSrc, entry, conf}){
    const div=document.createElement('div'); div.className='card';
    const head=document.createElement('header');
    const info=document.createElement('span'); info.className='small'; info.textContent=`OCR conf: ${(conf*100|0)}%`;
    head.appendChild(info);

    const thumb=document.createElement('img'); thumb.className='thumb'; thumb.src=imgSrc;

    const row=document.createElement('div'); row.className='row';
    const nameInput=document.createElement('input'); nameInput.placeholder='Име'; nameInput.value=entry?.name||'';
    const amtSpan=document.createElement('span'); amtSpan.className='pill'; amtSpan.textContent=entry?.amount!=null?`${entry.amount.toFixed(2)} лв`:'—';
    row.appendChild(nameInput); row.appendChild(amtSpan);

    const acts=document.createElement('div'); acts.className='actions';
    const accept=document.createElement('button'); accept.className='chip ok'; accept.textContent='Приеми';
    accept.onclick=async()=>{
      const nm=(nameInput.value||'').trim(); const amt=entry?.amount??0;
      if(!nm){ toast('Попълни име'); return; }
      const key=await sha(nm+'|'+amt+'|'+imgSrc.slice(-64));
      if(recentSet.has(key)){ toast('Вече е записано'); return; } recentSet.add(key);
      await db.add({ id:Date.now()+'-'+Math.random().toString(16).slice(2), name:nm, amount:amt, ts:Date.now() });
      div.remove(); toast(`Записано: ${nm} – ${amt.toFixed(2)} лв`); renderSearch(qEl.value||'');
    };
    const skip=document.createElement('button'); skip.className='chip danger'; skip.textContent='Пропусни'; skip.onclick=()=>div.remove();
    acts.appendChild(accept); acts.appendChild(skip);

    div.appendChild(head); div.appendChild(thumb); div.appendChild(row); div.appendChild(acts);
    queueEl.appendChild(div);
  }

  /*** Основен OCR поток ***/
  async function processBlock(tmpCanvas){
    const local=await ocrLocalPrinted(tmpCanvas);
    let text=local.text, conf=local.conf, cloudEntries=null;

    if(USE_CLOUD_FALLBACK && conf<CLIENT_CONF_THRESHOLD && OCR_URL){
      try{
        const cloud=await ocrCloudFromDataURL(tmpCanvas.toDataURL('image/png'));
        if((cloud.text||'').length>(text||'').length){ text=cloud.text; conf=cloud.conf; }
        cloudEntries=cloud.entries;
      }catch(e){ /* тихо */ }
    }

    let entry=null;
    if(cloudEntries && cloudEntries.length){ entry=cloudEntries[0]; }
    else{
      const parsed=parseEntries(text);
      if(parsed.length) entry=parsed[0];
    }

    const imgSrc=tmpCanvas.toDataURL('image/png');
    if(entry && conf>=AUTO_ACCEPT_THRESHOLD && entry.name && Number.isFinite(entry.amount)){
      const key=await sha(entry.name+'|'+entry.amount+'|'+imgSrc.slice(-64));
      if(!recentSet.has(key)){
        recentSet.add(key);
        await db.add({ id:Date.now()+'-'+Math.random().toString(16).slice(2), name:entry.name, amount:entry.amount, ts:Date.now() });
        toast(`Записано: ${entry.name} – ${entry.amount.toFixed(2)} лв`);
        return;
      }
    }
    queueCard({imgSrc, entry, conf});
  }

  /*** Запази ***/
  document.getElementById('btnSave').addEventListener('click', async ()=>{
    try{
      const png=ocr.toDataURL('image/png');
      const a=document.createElement('a'); a.href=png; a.download=`veresia-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
      document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove()},0);

      const blocks=segmentBlocks(ocr); if(!blocks.length){ toast('Няма мастило'); return; }

      for(const b of blocks){
        const tmp=document.createElement('canvas'); tmp.width=b.w; tmp.height=b.h;
        const tctx=tmp.getContext('2d'); tctx.fillStyle='#fff'; tctx.fillRect(0,0,b.w,b.h); tctx.drawImage(ocr,b.x,b.y,b.w,b.h,0,0,b.w,b.h);
        const printed=handwriteToPrintCanvas(tmp);
        await processBlock(printed);
      }

      dCtx.clearRect(0,0,display.width,display.height);
      oCtx.fillStyle='#ffffff'; oCtx.fillRect(0,0,ocr.width,ocr.height);
      toast('Готово: блоковете са в опашката / записани');
    }catch(err){ console.error(err); toast('Грешка при „Запази“'); }
  });

  // Първо търсене
  async function renderSearch(term){
    const items=(await db.all()).filter(x=>!term || x.name.toLowerCase().includes(term.toLowerCase()));
    items.sort((a,b)=>a.name.localeCompare(b.name,'bg') || a.ts-b.ts);
    rowsEl.innerHTML=''; let total=0;
    for(const it of items){ total+=it.amount; const div=document.createElement('div'); div.innerHTML=`<span>${it.name}</span><span>${it.amount.toFixed(2)} лв</span>`; rowsEl.appendChild(div); }
    sumEl.textContent=total.toFixed(2)+' лв';
  }
  renderSearch('');
  </script>
</body>
</html>
